<section class="dashboard">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: é€šçŸ¥ã‚¨ãƒªã‚¢ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
    <header class="dashboard__header">
        <div class="notification-area" aria-labelledby="notifications-page-title">
            <div class="notification-area__header-row">
                <h1 id="notifications-page-title">é€šçŸ¥ã‚¨ãƒªã‚¢</h1>
                <div class="notification-area__header-controls">
                    <button type="button" class="button button--accent" (click)="scrollToDailyWork()">
                        â¬æœ¬æ—¥ã®ä»•äº‹
                    </button>
                    <button type="button" class="user-chip" (click)="goToUserSettings()">
                        <ng-container *ngIf="userPhotoUrl(); else userInitial">
                            <img [src]="userPhotoUrl()" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³">
                        </ng-container>
                        <ng-template #userInitial>
                            <span class="user-chip__placeholder">{{ userDisplayName().slice(0, 1) }}</span>
                        </ng-template>
                        <span class="user-chip__name">{{ userDisplayName() }}</span>
                    </button>
                </div>
            </div>
            <div class="notification-area__summary-row">
                <div class="notification-area__chips">
                    <div class="summary-chip summary-chip--alert" role="status" aria-live="polite">
                        <span class="summary-chip__icon" aria-hidden="true">ğŸ””</span>
                        <span class="summary-chip__label">æœ¬æ—¥ç¢ºèªã™ã¹ãé€šçŸ¥</span>
                        <strong class="summary-chip__count">{{ notificationsLoading() ? 'â€”' : totalNotificationCount() }}ä»¶</strong>
                    </div>
                    <div class="summary-chip summary-chip--success" role="status" aria-live="polite">
                        <span class="summary-chip__icon" aria-hidden="true">âœ…</span>
                        <span class="summary-chip__label">æœ¬æ—¥çµ‚äº†ã‚¿ã‚¹ã‚¯</span>
                        <strong class="summary-chip__count">{{ notificationsLoading() ? 'â€”' : dueTodayTotalCount() }}ä»¶</strong>
                    </div>
                </div>
                <button type="button" class="button button--ghost notification-area__reload" (click)="reloadDashboard()"
                    [disabled]="snapshotLoading() || notificationsLoading()">
                    å†èª­ã¿è¾¼ã¿
                </button>
            </div>
            <p class="notification-area__headline" [class.notification-area__headline--error]="notificationsError()">
                {{ notificationHeadline() }}
            </p>
            <div class="notification-area__card">
                <div class="notification-card">
                    <p class="notification-card__state" *ngIf="notificationsLoading()">é€šçŸ¥ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
                    <p class="notification-card__state notification-card__state--error"
                        *ngIf="!notificationsLoading() && notificationsError()">
                        {{ notificationsError() }}
                    </p>
                    <ng-container *ngIf="!notificationsLoading() && !notificationsError()">
                        <ng-container *ngIf="notificationListItems() as notifications">
                            <p class="notification-card__state notification-card__state--empty"
                                *ngIf="notifications.length === 0">
                                æœ¬æ—¥ã®é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                            </p>
                            <div class="notification-card__list" *ngIf="notifications.length > 0">
                                <button type="button" class="notification-item"
                                    *ngFor="let item of notifications; trackBy: trackNotification"
                                    (click)="openNotification(item)">
                                    <span class="notification-item__marker"
                                        [ngClass]="{
                                            'notification-item__marker--mention': item.type === 'mention',
                                            'notification-item__marker--due-today': item.type === 'due_today',
                                            'notification-item__marker--overdue': item.type === 'overdue'
                                        }" aria-hidden="true"></span>
                                    <div class="notification-item__content">
                                        <span class="notification-item__title"
                                            [class.notification-item__title--unread]="item.isUnread">
                                            {{ item.title }}
                                        </span>
                                        <span class="notification-item__description">{{ item.description }}</span>
                                    </div>
                                    <div class="notification-item__meta">
                                        <span class="notification-item__time">
                                            {{ item.timestamp ? (item.timestamp | date: 'M/d HH:mm') : 'æ™‚åˆ»æœªè¨­å®š' }}
                                        </span>
                                        <span class="notification-item__arrow" aria-hidden="true">â†—</span>
                                    </div>
                                </button>
                            </div>
                        </ng-container>
                    </ng-container>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard__widgets">
        <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆâ‘ : ã‚µãƒãƒªãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
        <section class="widget widget--summary" aria-labelledby="summary-title">
            <div class="widget__header">
                <h2 id="summary-title">æ¦‚è¦ã‚µãƒãƒªãƒ¼</h2>
                <span class="widget__hint">é€²æ—ç‡ãƒ»æœŸé™ãƒ»é‡è¦åº¦ã‚’è‡ªå‹•é›†è¨ˆ</span>
            </div>
            <div class="widget__content widget__content--summary" *ngIf="!snapshotLoading(); else summaryLoading">
                <ng-container *ngIf="summaryMetrics() as summary; else summaryEmpty">
                    <div class="summary__chart">
                        <svg viewBox="0 0 36 36" class="donut">
                            <circle class="donut__bg" cx="18" cy="18" r="16"></circle>
                            <circle class="donut__value" cx="18" cy="18" r="16"
                                [attr.stroke-dasharray]="summary ? Math.round(summary.completionRate) + ' ' + (100 - Math.round(summary.completionRate)) : '0 100'">
                            </circle>
                        </svg>
                        <div class="summary__value">
                            <strong>{{ summary.completionRate | number: '1.0-0' }}%</strong>
                            <span>å…¨ã‚¿ã‚¹ã‚¯ã®å®Œäº†ç‡</span>
                        </div>
                        <p class="summary__caption">å¹³å‡é€²æ— {{ summary.averageProgress | number: '1.0-0' }}%</p>
                    </div>
                    <div class="summary__cards">
                        <article class="summary-card">
                            <h3>ã‚¿ã‚¹ã‚¯ç·æ•°</h3>
                            <p class="summary-card__value">{{ summary.totalTasks }}</p>
                            <span class="summary-card__hint">Criticalæœªç€æ‰‹ {{ summary.criticalChecklistBacklog }}</span>
                        </article>
                        <article class="summary-card">
                            <h3>æœŸé™è¶…é</h3>
                            <p class="summary-card__value">{{ summary.overdueCount }}</p>
                            <span class="summary-card__hint">è¦å†èª¿æ•´ã®ã‚¿ã‚¹ã‚¯</span>
                        </article>
                        <article class="summary-card">
                            <h3>é‡è¦åº¦</h3>
                            <ul class="summary-card__tags">
                                <li>è‡³æ€¥é‡è¦: {{ summary.importanceCounts.Critical }}</li>
                                <li>è‡³æ€¥: {{ summary.importanceCounts.High }}</li>
                                <li>é‡è¦: {{ summary.importanceCounts.Medium }}</li>
                                <li>æ™®é€š: {{ summary.importanceCounts.Low }}</li>
                            </ul>
                        </article>
                    </div>
                    <div class="summary__bars">
                        <div class="status-bar" *ngFor="let bar of summaryStatusBars()">
                            <span class="status-bar__label">{{ bar.label }}</span>
                            <div class="status-bar__track">
                                <div class="status-bar__fill" [style.width]="getStatusBarWidth(bar.value)"></div>
                            </div>
                            <span class="status-bar__value">{{ bar.value }}</span>
                        </div>
                    </div>
                </ng-container>
            </div>
        </section>

        <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆâ‘¡: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ -->
        <section class="widget widget--projects" aria-labelledby="projects-title">
            <div class="widget__header">
                <h2 id="projects-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—</h2>
                <div class="widget__actions">
                    <button type="button" class="button button--chip" *ngFor="let option of projectSortOptions"
                        [class.button--chip-active]="selectedSort() === option.value"
                        (click)="setProjectSort(option.value)">
                        {{ option.label }}
                    </button>
                </div>
            </div>
            <div class="widget__content widget__content--projects">
                <p class="widget__error" *ngIf="snapshotError()">{{ snapshotError() }}</p>
                <div class="widget__loading" *ngIf="snapshotLoading()">
                    <span class="spinner" aria-hidden="true"></span>
                    <span>èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                <p class="widget__empty" *ngIf="!snapshotLoading() && sortedProjectCards().length === 0">
                    è¡¨ç¤ºã§ãã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                </p>
                <ul class="project-list" *ngIf="!snapshotLoading() && sortedProjectCards().length > 0">
                    <li class="project-card" *ngFor="let project of (sortedProjectCards() | slice:0:2)"
                        [ngClass]="getWarningClass(project.warningLevel)">
                        <div class="project-card__header">
                            <h3>{{ project.name }}</h3>
                            <span class="project-card__members">ãƒ¡ãƒ³ãƒãƒ¼ {{ project.memberCount }}</span>
                        </div>
                        <div class="project-card__body">
                            <div class="project-card__progress">
                                <svg viewBox="0 0 36 36" class="donut">
                                    <circle class="donut__bg" cx="18" cy="18" r="16"></circle>
                                    <circle class="donut__value" cx="18" cy="18" r="16"
                                        [attr.stroke-dasharray]="getCompletionDasharray(project)"></circle>
                                </svg>
                                <div class="project-card__progress-text">
                                    <strong>{{ project.progress | number: '1.0-0' }}%</strong>
                                    <span>{{ getProgressDelta(project) || 'é€²æ—ç¢ºèªæ¸ˆã¿' }}</span>
                                </div>
                            </div>
                            <ul class="project-card__stats">
                                <li>èª²é¡Œ {{ project.issueCount }}</li>
                                <li>é‡è¦ã‚¿ã‚¹ã‚¯ {{ project.highPriorityBacklog }}</li>
                                <li>é…å»¶ {{ project.overdue ? 'ã‚ã‚Š' : 'ãªã—' }}</li>
                            </ul>
                            <div class="project-card__bars">
                                <div class="mini-bar" *ngFor="let bar of project.statusBars">
                                    <span class="mini-bar__label">{{ bar.label }}</span>
                                    <div class="mini-bar__track">
                                        <div class="mini-bar__fill"
                                            [style.width]="getProjectStatusWidth(project, bar.value)"></div>
                                    </div>
                                    <span class="mini-bar__value">{{ bar.value }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="project-card__footer">
                            <a class="button button--ghost" [routerLink]="['/projects', project.projectId]">è©³ç´°ã¸</a>
                            <button type="button" class="button button--primary"
                                (click)="openProjectSmartFilter(project.projectId)">
                                ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                            </button>
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆâ‘¢: ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¤œçŸ¥ -->
        <section class="widget widget--bottlenecks" aria-labelledby="bottleneck-title">
            <div class="widget__header">
                <h2 id="bottleneck-title">ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¤œçŸ¥</h2>
                <span class="widget__hint">é€²æ—0%ã€é•·æœŸä¿ç•™ã€Criticalç„¡æ‹…å½“ãªã©ã‚’æŠ½å‡º</span>
            </div>
            <div class="widget__content widget__content--bottlenecks">
                <p class="widget__empty" *ngIf="bottlenecks().length === 0">ç¾åœ¨æ¤œå‡ºã•ã‚ŒãŸãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <ul class="bottleneck-list" *ngIf="bottlenecks().length > 0">
                    <li class="bottleneck-item" *ngFor="let insight of bottlenecks(); trackBy: trackBottleneck">
                        <div class="bottleneck-item__body">
                            <span class="bottleneck-item__type">{{ insight.label }}</span>
                            <span class="bottleneck-item__id">PJ {{ insight.projectId }}<ng-container
                                    *ngIf="insight.issueId"> / Issue {{ insight.issueId }}</ng-container><ng-container
                                    *ngIf="insight.taskId"> / Task {{ insight.taskId }}</ng-container></span>
                        </div>
                        <button type="button" class="button button--ghost" (click)="goToSmartFilter(insight)">
                            ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                        </button>
                    </li>
                </ul>
            </div>
        </section>

        <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆâ‘£: æ²ç¤ºæ¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <section class="widget widget--board" aria-labelledby="board-title" id="daily-work-board">
            <div class="widget__header">
                <h2 id="board-title">æ²ç¤ºæ¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div class="widget__actions">
                    <a routerLink="/board" class="button button--ghost">ã‚‚ã£ã¨è¦‹ã‚‹</a>
                  </div>
            </div>
            <div class="widget__content widget__content--board">
                <div class="widget__loading" *ngIf="bulletinLoading()">
                    <span class="spinner" aria-hidden="true"></span>
                    <span>èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                <p class="widget__error" *ngIf="!bulletinLoading() && bulletinError()">
                    {{ bulletinError() }}
                </p>
                 <app-board-preview
      *ngIf="!bulletinLoading() && !bulletinError()"
      [posts]="bulletinPosts()"
      [embedded]="true">
    </app-board-preview>
            </div>
        </section>

        <!-- ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆâ‘¤: è¦å¯¾å¿œã‚¿ã‚¹ã‚¯ -->
        <section class="widget widget--deadlines" aria-labelledby="actionable-title" id="daily-work-actionable">
            <div class="widget__header">
                <h2 id="actionable-title">è¦å¯¾å¿œã‚¿ã‚¹ã‚¯</h2>
                <button type="button" class="button button--ghost" (click)="refreshActionableTasks()"
                    [disabled]="actionableLoading()">
                    å†èª­ã¿è¾¼ã¿
                </button>
            </div>
            <div class="widget__content widget__content--actionable">
                <div class="widget__loading" *ngIf="actionableLoading()">
                    <span class="spinner" aria-hidden="true"></span>
                    <span>èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                <p class="widget__error" *ngIf="!actionableLoading() && actionableError()">
                    {{ actionableError() }}
                </p>
                <p class="widget__empty"
                    *ngIf="!actionableLoading() && !actionableError() && actionableTasks().length === 0">
                    ç¾åœ¨å¯¾å¿œãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                </p>
                <ul class="actionable-list" *ngIf="!actionableLoading() && actionableTasks().length > 0">
                    <li class="actionable-card" *ngFor="let card of actionableTasks(); trackBy: trackTask">
                        <div class="actionable-card__header">
                            <span class="actionable-card__badge" [style.background-color]="card.badge.color">
                                {{ card.badge.label }}
                            </span>
                            <span class="actionable-card__project">{{ card.projectName }}</span>
                        </div>
                        <div class="actionable-card__body">
                            <h3>{{ card.title }}</h3>
                            <div class="actionable-card__meta">
                                <div class="actionable-card__meta-left">
                                    <span class="importance-chip" [ngClass]="getImportanceClass(card.importance)">
                                        {{ getImportanceLabel(card.importance) }}
                                    </span>
                                    <span class="status-badge" [ngClass]="'status-' + card.status">
                                        {{ card.statusLabel }}
                                    </span>
                                    <span class="due-label" *ngIf="card.dueDate">
                                        æœŸé™: {{ card.dueDate | date: 'yyyy/MM/dd' }}
                                    </span>
                                </div>
                                <div class="actionable-card__actions">
                                    <button type="button" class="button button--ghost" (click)="markOnHold(card)"
                                        [disabled]="isUpdating(card)">
                                        ä¿ç•™
                                    </button>
                                    <button type="button" class="button button--primary" (click)="markCompleted(card)"
                                        [disabled]="isUpdating(card)">
                                        å®Œäº†
                                    </button>
                                </div>
                            </div>
                            <div class="actionable-card__mentions" *ngIf="card.mentionCount > 0">
                                <h4>ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ {{ card.mentionCount }}ä»¶</h4>
                                <ul>
                                    <li *ngFor="let mention of card.mentions">
                                        <span class="mention-date">{{ mention.createdAt | date: 'MM/dd HH:mm' }}</span>
                                        <span class="mention-text">{{ mention.text }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </section>
    </div>
</section>

<ng-template #summaryLoading>
    <div class="widget__loading">
        <span class="spinner" aria-hidden="true"></span>
        <span>èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
</ng-template>

<ng-template #summaryEmpty>
    <p class="widget__empty">ã¾ã ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
</ng-template>