<div class="tasks-layout">
  <!-- å·¦å´å›ºå®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å…±é€šåŒ– -->
  <app-project-sidebar [currentProjectId]="projectId"></app-project-sidebar>

  <!-- ã‚¿ã‚¹ã‚¯ç”»é¢æœ¬ä½“ã‚’å³å´ã«é…ç½® -->
  <div class="tasks-container">
  <!-- èª²é¡Œã®ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ« -->
  <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¼·èª¿ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ•°ã‚’æ³¨å…¥ -->
  <section
    *ngIf="issueDetails"
    class="issue-summary"
    [ngStyle]="getIssueSummaryStyles()"
  >
    <div class="summary-header">
      <div class="summary-title">
        <span
          class="summary-color"
          [style.background-color]="getIssueThemeColor()"
        ></span>
        <div class="summary-text">
          <h3><span class="issue-label">èª²é¡Œ:</span> <span class="issue-name">{{ issueDetails.name }}</span></h3>
          <p class="summary-goal" *ngIf="issueDetails.goal"><span class="goal-label">é”æˆç›®æ¨™:</span> <span class="goal-content">{{ issueDetails.goal }}</span></p>
        </div>
      </div>
      <div class="summary-deadline">
        <span class="deadline-item deadline-item--start" *ngIf="issueDetails.startDate">
          <span class="deadline-label">é–‹å§‹</span>
          <span class="deadline-value">{{ issueDetails.startDate | date:'yyyy/MM/dd' }}</span>
        </span>
        <span class="deadline-item deadline-item--end" *ngIf="issueDetails.endDate">
          <span class="deadline-label">æœŸé™</span>
          <span class="deadline-value">{{ issueDetails.endDate | date:'yyyy/MM/dd' }}</span>
        </span>
      </div>
    </div>

    <p class="summary-description" *ngIf="issueDetails.description">{{ issueDetails.description }}</p>

    <div class="summary-progress">
      <span class="label">é€²æ—</span>
      <div class="progress-bar">
        <div
          class="progress-fill"
          [style.width.%]="issueProgress"
          [style.background-color]="getIssueThemeColor()"
        ></div>
      </div>
      <span class="value">{{ issueProgress | number:'1.0-1' }}%</span>
    </div>
  </section>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-left">
      <button class="btn btn-secondary back-button" type="button" (click)="goToIssuesList()">
        <span class="back-button__icon" aria-hidden="true">â†</span>
        èª²é¡Œä¸€è¦§
      </button>
      <h2>ã‚¿ã‚¹ã‚¯ä¸€è¦§ <span class="task-count">({{ filteredTasks.length }})</span></h2>
    </div>
    <button class="btn btn-primary" *ngIf="canCreateTask()" (click)="openCreateModal()">
      <i class="icon-plus"></i> æ–°è¦ã‚¿ã‚¹ã‚¯
    </button>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ä¸¦ã³æ›¿ãˆ -->
  <div class="filters">
    <div class="filter-group filter-group--smart">
      <button 
        type="button" 
        class="smart-filter-button" 
        [class.smart-filter-button--active]="!isSmartFilterEmpty(smartFilterCriteria)"
        (click)="toggleSmartFilterPanel()">
        <span class="smart-filter-button__icon" aria-hidden="true">âš™ï¸</span>
        ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      </button>
      <a class="search-button" routerLink="/search">
        <span class="search-button__icon" aria-hidden="true">ğŸ”</span>
        æ¤œç´¢
      </a>
      <app-smart-filter-panel
        *ngIf="smartFilterVisible"
        [scope]="smartFilterScope"
        [criteria]="smartFilterCriteria"
        [tags]="smartFilterTagOptions"
        [assignees]="smartFilterAssigneeOptions"
        [statusOptions]="smartFilterStatusOptions"
        [importanceOptions]="smartFilterImportanceOptions"
        (applyCriteria)="onSmartFilterApply($event)"
        (panelClosed)="smartFilterVisible = false"
      ></app-smart-filter-panel>
    </div>
    <div class="filter-group">
      <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
      <select [(ngModel)]="statusFilter" (change)="filterTasks()">
        <option value="">ã™ã¹ã¦</option>
        <option value="incomplete">æœªå®Œäº†</option>
        <option value="in_progress">é€²è¡Œä¸­</option>
        <option value="completed">å®Œäº†</option>
        <option value="on_hold">ä¿ç•™</option>
        <option value="discarded">ç ´æ£„</option>
      </select>
    </div>
    <div class="filter-group">
      <span>é‡è¦åº¦:</span>
      <select [(ngModel)]="importanceFilter" (change)="filterTasks()">
        <option value="">ã™ã¹ã¦</option>
        <option value="Critical">è‡³æ€¥é‡è¦</option>
        <option value="High">è‡³æ€¥</option>
        <option value="Medium">é‡è¦</option>
        <option value="Low">æ™®é€š</option>
      </select>
    </div>
    <div class="filter-group">
      <span>ä¸¦ã³æ›¿ãˆ:</span>
      <select [(ngModel)]="sortBy" (change)="sortTasks()">
        <option value="title">åç§°</option>
        <option value="startDate">é–‹å§‹æ—¥</option>
        <option value="endDate">çµ‚äº†æ—¥</option>
        <option value="progress">é€²æ—</option>
        <option value="importance">é‡è¦åº¦</option>
        <option value="createdAt">ä½œæˆæ—¥</option>
        <option value="period">æœŸé–“</option>
      </select>
      <select [(ngModel)]="sortOrder" (change)="sortTasks()">
        <option value="asc">æ˜‡é †</option>
        <option value="desc">é™é †</option>
      </select>
    </div>
    <div class="filter-group">
      <label>
        <input type="checkbox" [(ngModel)]="showArchived" (change)="filterTasks()">
        ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã‚‚è¡¨ç¤º
      </label>
    </div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
  <div class="tasks-grid">
    <div
      *ngFor="let task of filteredTasks"
      class="task-card"
      [id]="'task-' + task.id"
      [class.completed]="task.status === 'completed'"
      [class.discarded]="task.status === 'discarded'"
      [class.archived]="task.archived"
      [class.pinned]="isTaskPinned(task)"
      [style.--theme-color]="getIssueThemeColor()"
      [style.borderTopColor]="getIssueThemeColor()"
      (click)="selectTask(task)"
      (keydown.enter)="selectTask(task)"
      role="button"
      tabindex="0"
    >
      <div class="task-header">
        <div class="task-actions">
          <button
            class="btn-icon pin-button"
            type="button"
            (click)="toggleTaskPin(task, $event)"
            [title]="isTaskPinned(task) ? 'ãƒ”ãƒ³æ­¢ã‚è§£é™¤' : 'ãƒ”ãƒ³æ­¢ã‚'"
            [class.pinned]="isTaskPinned(task)"
            [attr.aria-pressed]="isTaskPinned(task)"
          >
            <i class="icon-pin" aria-hidden="true"></i>
          </button>
         <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³ã¨ç°¡æ˜“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã²ã¨ã¾ã¨ã‚ã«ã™ã‚‹ -->
         <div
         *ngIf="canEditTask(task)"
         class="task-status-menu"
       >
         <button
           type="button"
           class="btn-icon btn-icon--labeled task-complete-button"
           (click)="toggleStatusMenu(task, $event)"
           title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´"
           [attr.aria-expanded]="isStatusMenuOpen(task)"
         >
           <span class="btn-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</span>
           <span class="status-button-caret" aria-hidden="true">â–¾</span>
         </button>
         <ul
           *ngIf="isStatusMenuOpen(task)"
           class="task-status-menu__list"
           role="menu"
         >
           <li *ngFor="let option of taskStatusMenuOptions" role="none">
             <button
               type="button"
               class="task-status-menu__item"
               role="menuitem"
               (click)="updateTaskStatus(task, option.value, $event)"
               [class.is-active]="task.status === option.value"
             >
               {{ option.label }}
             </button>
           </li>
         </ul>
       </div>
          <!-- ç·¨é›†ãƒœã‚¿ãƒ³ã¯ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã—ã¦æ“ä½œã‚’æ˜ç¢ºåŒ– -->
          <button class="btn-icon btn-icon--labeled" *ngIf="canEditTask(task)" (click)="editTask(task, $event)" title="ç·¨é›†">
            <i class="icon-edit" aria-hidden="true"></i>
            <span class="btn-label">ğŸ“ç·¨é›†</span>
          </button>
        <button class="btn-icon btn-icon--labeled" *ngIf="canDeleteTask(task)" (click)="deleteTask(task, $event)" title="å‰Šé™¤">
          <i class="icon-delete" aria-hidden="true"></i>
          <span class="btn-label">å‰Šé™¤</span>
        </button>
        </div>
        <div class="task-title">
        <div
            class="task-theme-marker"
            [style.background-color]="getIssueThemeColor()"
          ></div>
          <span class="pin-indicator" *ngIf="isTaskPinned(task)" aria-hidden="true">ğŸ“Œ</span>
          <h3>{{ task.title }}</h3>
          <span class="importance-chip" [ngClass]="getImportanceClass(task.importance)">
            {{ getImportanceLabel(task.importance) }}
          </span>
        </div>
      </div>

      <div class="task-flags" *ngIf="task.archived">
        <span class="flag archived-flag">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿</span>
      </div>
      
      <div class="task-content">
        <p class="description" *ngIf="task.description">{{ task.description }}</p>
        
        <div class="task-meta">
          <div class="meta-item" *ngIf="task.startDate">
            <i class="icon-calendar"></i>
            {{ task.startDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item" *ngIf="task.endDate">
            <i class="icon-calendar"></i>
            {{ task.endDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item">
            <span class="status-badge" [class]="'status-' + task.status">
              {{ getStatusLabel(task.status) }}
            </span>
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>é€²æ—</span>
          </div>
          <div class="detail-progress">
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="getTaskProgress(task)"
                [style.background-color]="getIssueThemeColor()"
              ></div>
            </div>
            <span class="progress-value">{{ getTaskProgress(task) | number:'1.0-0' }}%</span>
          </div>
        </div>

        <div class="task-tags" *ngIf="getVisibleTagIds(task).length > 0">
          <span
            *ngFor="let tagId of getVisibleTagIds(task)"
            class="tag"
            [style.background-color]="getTagColor(tagId)"
          >
            {{ getTagName(tagId) }}
          </span>
        </div>

        <div class="task-stats">
          <div class="stat-item">
            <span class="stat-label">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</span>
            <span class="stat-value">{{ task.checklist.length }}é …ç›®</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å®Œäº†</span>
            <span class="stat-value">{{ getCompletedChecklistCount(task) }}é …ç›®</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ…‹ -->
  <div *ngIf="tasks.length === 0" class="empty-state">
    <i class="icon-folder"></i>
    <h3>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</h3>
    <p>æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†</p>
        <button class="btn btn-primary" *ngIf="canCreateTask()" (click)="openCreateModal()">
      ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
    </button>
  </div>
</div>
</div>

 <!-- ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ‘ãƒãƒ« -->
 <div *ngIf="selectedTask" class="task-detail-container">
  <div
    class="task-detail-backdrop"
    (click)="closeDetailPanel()"
    (keydown.enter)="closeDetailPanel()"
    (keydown.space)="closeDetailPanel()"
    role="button"
    tabindex="0"
    aria-label="è©³ç´°ã‚’é–‰ã˜ã‚‹"
  ></div>
  <aside
    class="task-detail-panel"
    [style.borderTopColor]="getIssueThemeColor()"
    role="dialog"
    aria-modal="true"
  >
    <div class="detail-header">
      <div class="detail-title">
        <span class="importance-chip" [ngClass]="getImportanceClass(selectedTask.importance)">
          {{ getImportanceLabel(selectedTask.importance) }}
        </span>
        <h2>{{ selectedTask.title }}</h2>
      </div>
      <div class="detail-actions">
        <button class="btn btn-secondary btn-sm" *ngIf="canEditTask(selectedTask)" (click)="editTask(selectedTask, $event)">
          ç·¨é›†
        </button>
        <button class="btn btn-secondary btn-sm" *ngIf="canEditTask(selectedTask)" (click)="archiveTask(selectedTask, $event)">
          {{ selectedTask.archived ? 'å¾©å…ƒ' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }}
        </button>
        <button class="btn-icon" (click)="closeDetailPanel()" aria-label="é–‰ã˜ã‚‹">
          <i class="icon-close"></i>
        </button>
      </div>
    </div>

    <p class="detail-description" *ngIf="selectedTask.description">{{ selectedTask.description }}</p>

    <section class="detail-section">
      <h3>åŸºæœ¬æƒ…å ±</h3>
      <dl class="detail-meta">
        <div>
          <dt>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
          <dd>
            <span class="status-badge" [class]="'status-' + selectedTask.status">
              {{ getStatusLabel(selectedTask.status) }}
            </span>
          </dd>
        </div>
        <div>
          <dt>é‡è¦åº¦</dt>
          <dd>
            <span class="importance-chip" [ngClass]="getImportanceClass(selectedTask.importance)">
              {{ getImportanceLabel(selectedTask.importance) }}
            </span>
          </dd>
        </div>
        <div *ngIf="selectedTask.startDate">
          <dt>é–‹å§‹æ—¥</dt>
          <dd>{{ selectedTask.startDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="selectedTask.endDate">
          <dt>çµ‚äº†æ—¥</dt>
          <dd>{{ selectedTask.endDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="selectedTask.goal" class="goal-item">
          <dt>é”æˆç›®æ¨™</dt>
          <dd>{{ selectedTask.goal }}</dd>
        </div>
      </dl>
    </section>

    <section class="detail-section">
      <h3>é€²æ—</h3>
      <div class="detail-progress">
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="getTaskProgress(selectedTask)"
            [style.background-color]="getIssueThemeColor()"
          ></div>
        </div>
        <span class="progress-value">{{ getTaskProgress(selectedTask) | number:'1.0-0' }}%</span>
      </div>
    </section>

    <section class="detail-section">
      <h3>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ <span class="checklist-count">({{ selectedTask.checklist.length }}/200)</span> <span class="checklist-hint">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„</span></h3>
      <div *ngIf="selectedTask.checklist.length > 0; else emptyChecklist">
        <div class="detail-checklist-item" *ngFor="let item of selectedTask.checklist">
          <label>
            <input
              type="checkbox"
              [checked]="item.completed"
              [disabled]="!canEditTask(selectedTask)"
              (change)="toggleChecklistItem(selectedTask!, item.id, $any($event.target).checked)"
            >
            <span [class.completed]="item.completed">{{ item.text }}</span>
          </label>
          <button
            type="button"
            class="btn-icon"
            *ngIf="canEditTask(selectedTask)"
            (click)="removeChecklistItemFromDetail(item.id)"
            title="å‰Šé™¤"
          >
            <i class="icon-delete"></i>
          </button>
        </div>
      </div>
      <ng-template #emptyChecklist>
        <p class="placeholder-text">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </ng-template>
      <div class="detail-checklist-add">
        <input
          type="text"
          [(ngModel)]="newChecklistText"
          placeholder="æ–°ã—ã„é …ç›®ã‚’å…¥åŠ›"
          maxlength="100"
          (keydown.enter)="addChecklistItemFromDetail()"
          [disabled]="!canEditTask(selectedTask)"
        >
        <button type="button" class="btn btn-secondary btn-sm" (click)="addChecklistItemFromDetail()" [disabled]="!canEditTask(selectedTask)">
          è¿½åŠ 
        </button>
      </div>
    </section>

    <section class="detail-section" *ngIf="getVisibleTagIds(selectedTask).length > 0">
      <h3>ã‚¿ã‚° <span class="tag-count">({{ selectedTask.tagIds.length }}/10)</span></h3>
      <div class="detail-tags">
        <span
        *ngFor="let tagId of getVisibleTagIds(selectedTask)"
          class="tag"
          [style.background-color]="getTagColor(tagId)"
        >
          {{ getTagName(tagId) }}
        </span>
      </div>
    </section>

    <section class="detail-section">
      <h3>æ‹…å½“è€… <span class="assignee-count">({{ selectedTask.assigneeIds.length }}/10)</span></h3>
      <p *ngIf="selectedTask.assigneeIds.length === 0" class="placeholder-text">æ‹…å½“è€…ã¯ã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      <ul *ngIf="selectedTask.assigneeIds.length > 0" class="assignee-list">
        <li *ngFor="let assigneeId of selectedTask.assigneeIds" class="assignee-item">
          <ng-container *ngIf="getAssigneePhotoUrl(assigneeId) as photoUrl; else assigneeFallback">
            <span class="assignee-avatar assignee-avatar--image">
              <img [src]="photoUrl" [alt]="getAssigneeDisplayName(assigneeId) + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
            </span>
          </ng-container>
          <ng-template #assigneeFallback>
            <span
              class="assignee-avatar assignee-avatar--fallback"
              [style.backgroundColor]="getMemberAvatarColor(assigneeId)"
            >
              {{ getAssigneeInitial(assigneeId) }}
            </span>
          </ng-template>
          <span class="assignee-name">{{ getAssigneeDisplayName(assigneeId) }}</span>
        </li>
      </ul>
      <div class="assignee-actions" *ngIf="shouldShowAssigneeActions()">
        <button
          type="button"
          class="btn btn-primary btn-sm"
          *ngIf="shouldShowJoinButton()"
          (click)="joinSelectedTask()"
          [disabled]="assigneeActionInProgress"
        >
        {{ assigneeActionInProgress && assigneeActionInProgressLabel === 'join' ? 'å‚åŠ å‡¦ç†ä¸­...' : 'å‚åŠ ' }}
      </button>
      <button
        type="button"
        class="btn btn-secondary btn-sm"
        *ngIf="shouldShowLeaveButton()"
        (click)="leaveSelectedTask()"
        [disabled]="assigneeActionInProgress"
      >
        {{ assigneeActionInProgress && assigneeActionInProgressLabel === 'leave' ? 'é€€å‡ºå‡¦ç†ä¸­...' : 'é€€å‡º' }}
        </button>
      </div>
      <div
        *ngIf="assigneeActionMessage"
        class="feedback"
        [ngClass]="{
          'feedback--success': assigneeActionMessageType === 'success',
          'feedback--error': assigneeActionMessageType === 'error',
          'feedback--info': assigneeActionMessageType === 'info'
        }"
      >
        <i [class]="getAssigneeActionIcon()" aria-hidden="true"></i>
        {{ assigneeActionMessage }}
      </div>
    </section>

    <section class="detail-section attachments-section">
      <div class="section-header">
        <h3>æ·»ä»˜ <span class="attachment-count">({{ attachments.length }}/20)</span></h3>
        <div class="attachment-actions" *ngIf="canUploadAttachment(selectedTask)">
          <label class="btn btn-secondary btn-sm attachment-upload-button">
            <input
              type="file"
              multiple
              (change)="onAttachmentSelected($event)"
              [disabled]="attachmentUploading || attachmentLimitReached"
            >
            {{ attachmentUploading ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'æ·»ä»˜ã‚’è¿½åŠ ' }}
          </label>
          <p class="attachment-limit-message" *ngIf="attachmentLimitReached">
            æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€å¤§{{ attachmentLimit }}ä»¶ã¾ã§ã§ã™ã€‚
          </p>
        </div>
      </div>

      <p *ngIf="attachmentsLoading" class="placeholder-text">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>

      <div *ngIf="attachmentsError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentsError }}
      </div>

      <div *ngIf="attachmentUploadMessage" class="feedback feedback--success">
        <i class="icon-success" aria-hidden="true"></i>
        {{ attachmentUploadMessage }}
      </div>

      <div *ngIf="attachmentUploadError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentUploadError }}
      </div>

      <ul
        class="attachment-list"
        *ngIf="!attachmentsLoading && attachments.length > 0; else noAttachments"
      >
        <li
          class="attachment-item"
          [id]="'attachment-' + attachment.id"
          *ngFor="let attachment of attachments; trackBy: trackAttachmentById"
        >
          <div class="attachment-main">
            <a
              class="attachment-name"
              [href]="attachment.fileUrl"
              (click)="downloadAttachment(attachment, $event)"
              target="_blank"
              rel="noopener"
            >
              {{ attachment.fileName }}
            </a>
            <span class="attachment-size">{{ formatFileSize(attachment.fileSize) }}</span>
            <button
              type="button"
              class="btn-icon btn-icon--labeled attachment-delete"
              *ngIf="canDeleteAttachment(attachment)"
              (click)="deleteAttachment(attachment)"
              [disabled]="attachmentDeletingId === attachment.id"
            >
              <i class="icon-delete" aria-hidden="true"></i>
              <span class="btn-label">{{ attachmentDeletingId === attachment.id ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤' }}</span>
            </button>
          </div>
          <div class="attachment-meta">
            <span class="attachment-uploader">
              <ng-container *ngIf="attachment.uploaderPhotoUrl; else uploaderFallback">
                <img [src]="attachment.uploaderPhotoUrl" [alt]="attachment.uploaderLabel + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
              </ng-container>
              <ng-template #uploaderFallback>
                <span
                  class="attachment-uploader-fallback"
                  [style.backgroundColor]="getMemberAvatarColor(attachment.uploadedBy)"
                >
                  {{ getAttachmentInitial(attachment) }}
                </span>
              </ng-template>
              <span class="attachment-uploader-name">{{ attachment.uploaderLabel }}</span>
            </span>
            <time class="attachment-time">
              {{ attachment.uploadedAt ? (attachment.uploadedAt | date:'yyyy/MM/dd HH:mm') : '---' }}
            </time>
          </div>
        </li>
      </ul>

      <ng-template #noAttachments>
        <p *ngIf="!attachmentsLoading && attachments.length === 0 && !attachmentsError" class="placeholder-text">
          æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>
      </ng-template>
    </section>

    <section class="detail-section comments-section">
      <div class="comments-header">
        <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
        <span class="comments-count">{{ comments.length }}/500</span>
      </div>

      <div *ngIf="commentsLoading" class="comments-loading">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</div>
      <div *ngIf="commentError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ commentError }}
      </div>

      <div *ngIf="!commentsLoading && comments.length > 0" class="comments-list">
        <article class="comment-item" [id]="'comment-' + comment.id" *ngFor="let comment of comments">
          <div class="comment-avatar">
            <ng-container *ngIf="comment.authorPhotoUrl; else commentAvatarFallback">
              <img [src]="comment.authorPhotoUrl" [alt]="comment.authorUsername + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
            </ng-container>
            <ng-template #commentAvatarFallback>
              <span class="comment-avatar-fallback" [style.backgroundColor]="getCommentAvatarColor(comment)">
                {{ getCommentInitial(comment) }}
              </span>
            </ng-template>
          </div>
          <div class="comment-body">
            <div class="comment-meta">
              <div class="comment-meta__info">
                <span class="comment-author">{{ comment.authorUsername }}</span>
                <time class="comment-time">{{ comment.createdAt | date:'yyyy/MM/dd HH:mm' }}</time>
              </div>
              <button
                type="button"
                class="comment-delete-button"
                *ngIf="canDeleteComment(comment)"
                (click)="deleteComment(comment)"
                [disabled]="commentDeletingId === comment.id"
                aria-label="ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤"
              >
                {{ commentDeletingId === comment.id ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤' }}
              </button>
            </div>
            <p class="comment-text">
              <ng-container *ngFor="let segment of parseCommentText(comment.text, comment.mentions || [])">
                <ng-container *ngIf="segment.type === 'text'">{{ segment.content }}</ng-container>
                <span *ngIf="segment.type === 'mention'" class="mention-chip">
                  {{ segment.content }}
                </span>
              </ng-container>
            </p>
          </div>
        </article>
      </div>
      <p *ngIf="!commentsLoading && comments.length === 0 && !commentError" class="placeholder-text">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

      <p *ngIf="commentLimitReached" class="comment-limit-message">ã‚³ãƒ¡ãƒ³ãƒˆæ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆæœ€å¤§500ä»¶ï¼‰ã€‚</p>

      <div class="comment-form" *ngIf="canPostComment(); else commentPermissionNotice">
        <textarea
          [(ngModel)]="commentForm.text"
          name="taskComment"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ï¼ˆæœ€å¤§5000æ–‡å­—ï¼‰"
          [maxlength]="5000"
          [disabled]="commentSubmitting || commentLimitReached"
          (input)="commentError = ''"
          aria-label="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"
        ></textarea>

        <div class="comment-form-footer">
          <div class="comment-form-toolbar">
            <button
              type="button"
              class="btn btn-secondary btn-sm mention-toggle"
              (click)="toggleMentionSelector()"
              [disabled]="mentionableMembers.length === 0"
              aria-haspopup="listbox"
              [attr.aria-expanded]="mentionSelectorOpen"
              [attr.aria-controls]="mentionSelectorPanelId"
            >
              <span class="mention-toggle-icon">&#64;</span>
              <span class="mention-toggle-label">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³</span>
            </button>
            <span class="mention-helper" *ngIf="mentionableMembers.length === 0">
              ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚
            </span>
          </div>

          <div
            class="mention-selector"
            *ngIf="mentionSelectorOpen && mentionableMembers.length > 0"
            [attr.id]="mentionSelectorPanelId"
            role="listbox"
            aria-label="ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œ"
          >
            <p class="mention-helper-text">ã‚¿ã‚¹ã‚¯ã®æ‰€å±ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <div class="mention-list">
              <button
                type="button"
                class="mention-option"
                *ngFor="let member of mentionableMembers"
                (click)="toggleMention(member)"
                [class.selected]="isMentionSelected(member.uid)"
              >
                <ng-container *ngIf="member.photoURL; else mentionAvatarFallback">
                  <span class="mention-avatar">
                    <img [src]="member.photoURL" [alt]="member.username + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
                  </span>
                </ng-container>
                <ng-template #mentionAvatarFallback>
                  <span class="mention-avatar-fallback" [style.backgroundColor]="getMemberAvatarColor(member.uid)">
                    {{ getMemberInitial(member) }}
                  </span>
                </ng-template>
                <span class="mention-name">{{ member.username }}</span>
                <span class="mention-check" *ngIf="isMentionSelected(member.uid)">âœ“</span>
              </button>
            </div>
          </div>

          <div class="comment-actions">
            <span class="char-count">{{ commentForm.text.length }}/5000</span>
            <button
              type="button"
              class="btn btn-primary"
              (click)="submitComment()"
              [disabled]="!canSubmitComment() || commentSubmitting"
            >
              {{ commentSubmitting ? 'æŠ•ç¨¿ä¸­...' : 'æŠ•ç¨¿' }}
            </button>
          </div>
        </div>
      </div>

      <ng-template #commentPermissionNotice>
        <p class="placeholder-text">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ç®¡ç†è€…ã¾ãŸã¯ãƒ¡ãƒ³ãƒãƒ¼æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</p>
      </ng-template>
    </section>
  </aside>
</div>

<!-- ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div *ngIf="showModal" class="modal-overlay" (keydown.escape)="closeModal()" role="button" tabindex="-1">
  <div class="modal" (click)="$event.stopPropagation()" role="button" tabindex="-1">
    <div class="modal-header">
      <h2>{{ editingTask ? 'ã‚¿ã‚¹ã‚¯ç·¨é›†' : 'æ–°è¦ã‚¿ã‚¹ã‚¯' }}</h2>
       <!-- æ˜ç¤ºçš„ãªÃ—ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã—ã¦é–‰ã˜ã‚‹æ“ä½œã‚’åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ -->
       <button
       class="btn-icon close-button"
       (click)="closeModal()"
       type="button"
       aria-label="é–‰ã˜ã‚‹"
     >
       Ã—
      </button>
    </div>
    
    <form class="modal-body" (ngSubmit)="saveTask()">
      <div class="form-group">
        <label for="title">ã‚¿ã‚¤ãƒˆãƒ« * <span class="required-label">å¿…é ˆé …ç›®</span> <span class="char-count-label" [class.char-count-label--warning]="getTitleCharCount() > 70">{{ getTitleCharCount() }} / 80å­—</span></label>
        <input 
          id="title"
          type="text" 
          [(ngModel)]="taskForm.title" 
          name="title"
          required
          maxlength="80"
          placeholder="ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
        >
      </div>
      
      <div class="form-group">
        <label for="description">èª¬æ˜ <span class="char-count-label" [class.char-count-label--warning]="getDescriptionCharCount() > 450">{{ getDescriptionCharCount() }} / 500å­—</span></label>
        <textarea 
          id="description"
          [(ngModel)]="taskForm.description" 
          name="description"
          maxlength="500"
          placeholder="ã‚¿ã‚¹ã‚¯ã®èª¬æ˜ã‚’å…¥åŠ›"
          rows="3"
        ></textarea>
      </div>
      
      <!-- é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’åŒã˜è¡Œã§æ‰±ã„ã€ååˆ†ãªä½™ç™½ã‚’ç¢ºä¿ã—ã¦èª­ã¿ã‚„ã™ãã™ã‚‹ -->
      <div class="form-row form-row--dates">
        <div class="form-group">
          <label for="startDate">é–‹å§‹æ—¥</label>
          <input 
            id="startDate"
            type="date"
            [(ngModel)]="taskForm.startDate"
            name="startDate"
          >
        </div>
        <div class="form-group">
          <label for="endDate">çµ‚äº†æ—¥</label>
          <input 
            id="endDate"
            type="date"
            [(ngModel)]="taskForm.endDate"
            name="endDate"
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="importance">é‡è¦åº¦</label>
          <select id="importance" [(ngModel)]="taskForm.importance" name="importance">
          <option value="Low">æ™®é€š</option>
            <option value="Medium">é‡è¦</option>
            <option value="High">è‡³æ€¥</option>
            <option value="Critical">è‡³æ€¥é‡è¦</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="status" [(ngModel)]="taskForm.status" name="status">
            <option value="incomplete">æœªå®Œäº†</option>
            <option value="in_progress">é€²è¡Œä¸­</option>
            <option value="completed">å®Œäº†</option>
            <option value="on_hold">ä¿ç•™</option>
            <option value="discarded">ç ´æ£„</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal">é”æˆç›®æ¨™ <span class="char-count-label" [class.char-count-label--warning]="getGoalCharCount() > 450">{{ getGoalCharCount() }} / 500å­—</span></label>
        <textarea 
          id="goal"
          [(ngModel)]="taskForm.goal" 
          name="goal"
          maxlength="500"
          placeholder="ã‚¿ã‚¹ã‚¯ã®é”æˆç›®æ¨™ã‚’å…¥åŠ›"
          rows="2"
        ></textarea>
      </div>

      <div class="form-group">
        <span>ã‚¿ã‚° <span class="tag-hint">ã‚¿ã‚°åã¯æœ€å¤§10æ–‡å­—ã¾ã§ã§ã™</span></span>
        <div class="tag-selector">
           <!-- æ—¢å­˜ã‚¿ã‚°ã‚’ã‚°ãƒªãƒƒãƒ‰çŠ¶ã«è¡¨ç¤ºã—ã€ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã™ã‚‹ -->
           <div
           *ngFor="let tag of availableTags"
            class="tag-option"
            [class.selected]="taskForm.tagIds.includes(tag.id!)"
            (click)="toggleTag(tag.id!)"
            (keydown.enter)="toggleTag(tag.id!)"
            role="button"
            tabindex="0"
          >
            <span
              class="tag-color"
              [style.background-color]="tag.color || '#ccc'"
            ></span>
            <span class="tag-name">{{ tag.name }}</span>
            <button
              *ngIf="canDeleteTag(tag)"
              type="button"
              class="tag-delete-button"
              (click)="deleteCustomTag(tag, $event)"
              aria-label="ã‚¿ã‚°ã‚’å‰Šé™¤"
              title="å‰Šé™¤"
            >
              <i class="icon-delete"></i>
            </button>
          </div>
        </div>
        <div class="custom-tag-controls">
           <!-- ã‚«ãƒ©ãƒ¼å…¥åŠ›ã‚’å·¦å´ã«å›ºå®šã—ã€è¦–ç·šç§»å‹•ã‚’æœ€å°åŒ–ã™ã‚‹ -->
           <input
           type="color"
           [(ngModel)]="newTagColor"
           name="newTagColor"
           class="custom-tag-color"
           aria-label="ã‚¿ã‚°ã‚«ãƒ©ãƒ¼"
         >
          <!-- ã‚¿ã‚°åã®å…¥åŠ›æ¬„ã€‚trimå¾Œã«ç©ºãªã‚‰ä½œæˆã§ããªã„ -->
          <input
            type="text"
            [(ngModel)]="newTagName"
            name="newTagName"
            class="custom-tag-name"
            placeholder="æ–°ã—ã„ã‚¿ã‚°åã‚’å…¥åŠ›"
            maxlength="10"
          >
         
          <button
            type="button"
            class="btn btn-secondary btn-sm"
            (click)="createCustomTag()"
            [disabled]="creatingTag"
          >
            {{ creatingTag ? 'ä½œæˆä¸­...' : 'ã‚¿ã‚°ã‚’è¿½åŠ ' }}
          </button>
        </div>
        <span class="tag-info-hint">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ã‚¿ã‚°ã¯æœ€å¤§20å€‹ã¾ã§ä¿å­˜ã§ãã‚‹ <span class="tag-count-label" [class.tag-count-label--warning]="availableTags.length >= 18">{{ availableTags.length }} / 20</span></span>
      </div>

      <div class="form-group">
        <span>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ <span class="checklist-hint">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„</span></span>
        <div class="checklist-editor">
          <div 
            *ngFor="let item of taskForm.checklist; let i = index" 
            class="checklist-item"
          >
            <input 
              type="checkbox" 
              class="checklist-toggle"
              [(ngModel)]="item.completed"
              [name]="'checklist-' + i"
            >
            <input 
              type="text" 
              [(ngModel)]="item.text"
              [name]="'checklist-text-' + i"
              placeholder="ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’å…¥åŠ›"
              maxlength="100"
              class="checklist-input"
            >
            <button 
              type="button" 
              class="btn-icon" 
              (click)="removeChecklistItem(i)"
              title="å‰Šé™¤"
            >
              <i class="icon-delete"></i>
            </button>
          </div>
          <button 
            type="button" 
            class="btn btn-secondary btn-sm" 
            (click)="addChecklistItem()"
          >
            <i class="icon-plus"></i> é …ç›®ã‚’è¿½åŠ 
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!taskForm.title || saving">
          {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
        </button>
      </div>
    </form>
  </div>
</div>

