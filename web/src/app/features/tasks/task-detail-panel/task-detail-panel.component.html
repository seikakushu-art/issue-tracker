<!-- ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ‘ãƒãƒ« -->
<div *ngIf="visible && task" class="task-detail-container">
  <div
    class="task-detail-backdrop"
    (click)="close()"
    (keydown.enter)="close()"
    (keydown.space)="close()"
    role="button"
    tabindex="0"
    aria-label="è©³ç´°ã‚’é–‰ã˜ã‚‹"
  ></div>
  <aside
    class="task-detail-panel"
    [style.borderTopColor]="getIssueThemeColor()"
    role="dialog"
    aria-modal="true"
  >
    <div class="detail-header">
      <div class="detail-title">
        <span class="importance-chip" [ngClass]="getImportanceClass(task.importance)">
          {{ getImportanceLabel(task.importance) }}
        </span>
        <h2>{{ task.title }}</h2>
      </div>
      <div class="detail-actions">
        <button class="btn btn-secondary btn-sm" *ngIf="canEditTask(task)" (click)="requestEdit()">
          ğŸ“ç·¨é›†
        </button>
        <button class="btn btn-secondary btn-sm" *ngIf="canEditTask(task)" (click)="toggleArchive(task)">
          {{ task.archived ? 'å¾©å…ƒ' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }}
        </button>
        <button class="btn-icon" (click)="close()" aria-label="é–‰ã˜ã‚‹">
          <i class="icon-close"></i>
        </button>
      </div>
    </div>

    <p class="detail-description" *ngIf="task.description">{{ task.description }}</p>

    <section class="detail-section">
      <h3>åŸºæœ¬æƒ…å ±</h3>
      <dl class="detail-meta">
        <div>
          <dt>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
          <dd>
            <span class="status-badge" [class]="'status-' + task.status">
              {{ getStatusLabel(task.status) }}
            </span>
          </dd>
        </div>
        <div>
          <dt>é‡è¦åº¦</dt>
          <dd>
            <span class="importance-chip" [ngClass]="getImportanceClass(task.importance)">
              {{ getImportanceLabel(task.importance) }}
            </span>
          </dd>
        </div>
        <div *ngIf="task.startDate">
          <dt>é–‹å§‹æ—¥</dt>
          <dd>{{ task.startDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="task.endDate">
          <dt>çµ‚äº†æ—¥</dt>
          <dd>{{ task.endDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="task.goal">
          <dt>é”æˆç›®æ¨™</dt>
          <dd>{{ task.goal }}</dd>
        </div>
      </dl>
    </section>

    <section class="detail-section">
      <h3>é€²æ—</h3>
      <div class="detail-progress">
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="getTaskProgress(task)"
            [style.background-color]="getIssueThemeColor()"
          ></div>
        </div>
        <span class="progress-value">{{ getTaskProgress(task) | number:'1.0-0' }}%</span>
      </div>
    </section>

    <section class="detail-section">
      <h3>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
      <div *ngIf="task.checklist.length > 0; else emptyChecklist">
        <div class="detail-checklist-item" *ngFor="let item of task.checklist">
          <label>
            <input
              type="checkbox"
              [checked]="item.completed"
              [disabled]="!canEditTask(task)"
              (change)="toggleChecklistItem(item.id, $any($event.target).checked)"
            >
            <span [class.completed]="item.completed">{{ item.text }}</span>
          </label>
          <button
            type="button"
            class="btn-icon"
            *ngIf="canEditTask(task)"
            (click)="removeChecklistItem(item.id)"
            title="å‰Šé™¤"
          >
            <i class="icon-delete"></i>
          </button>
        </div>
      </div>
      <ng-template #emptyChecklist>
        <p class="placeholder-text">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </ng-template>
      <div class="detail-checklist-add">
        <input
          type="text"
          [(ngModel)]="newChecklistText"
          placeholder="æ–°ã—ã„é …ç›®ã‚’å…¥åŠ›"
          (keydown.enter)="addChecklistItem()"
          [disabled]="!canEditTask(task)"
        >
        <button type="button" class="btn btn-secondary btn-sm" (click)="addChecklistItem()" [disabled]="!canEditTask(task)">
          è¿½åŠ 
        </button>
      </div>
    </section>

    <section class="detail-section" *ngIf="getVisibleTagIds(task).length > 0">
      <h3>ã‚¿ã‚°</h3>
      <div class="detail-tags">
        <span
        *ngFor="let tagId of getVisibleTagIds(task)"
          class="tag"
          [style.background-color]="getTagColor(tagId)"
        >
          {{ getTagName(tagId) }}
        </span>
      </div>
    </section>

    <section class="detail-section">
      <h3>æ‹…å½“è€…</h3>
      <p *ngIf="task.assigneeIds.length === 0" class="placeholder-text">æ‹…å½“è€…ã¯ã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      <ul *ngIf="task.assigneeIds.length > 0" class="assignee-list">
        <li *ngFor="let assigneeId of task.assigneeIds" class="assignee-item">
          <ng-container *ngIf="getAssigneePhotoUrl(assigneeId) as photoUrl; else assigneeFallback">
            <span class="assignee-avatar assignee-avatar--image">
              <img [src]="photoUrl" [alt]="getAssigneeDisplayName(assigneeId) + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
            </span>
          </ng-container>
          <ng-template #assigneeFallback>
            <span
              class="assignee-avatar assignee-avatar--fallback"
              [style.backgroundColor]="getMemberAvatarColor(assigneeId)"
            >
              {{ getAssigneeInitial(assigneeId) }}
            </span>
          </ng-template>
          <span class="assignee-name">{{ getAssigneeDisplayName(assigneeId) }}</span>
        </li>
      </ul>
    </section>

    <section class="detail-section attachments-section">
      <div class="section-header">
        <h3>æ·»ä»˜</h3>
        <div class="attachment-actions" *ngIf="canUploadAttachment(task)">
          <label class="btn btn-secondary btn-sm attachment-upload-button">
            <input
              type="file"
              multiple
              (change)="onAttachmentSelected($event)"
              [disabled]="attachmentUploading || attachmentLimitReached"
            >
            {{ attachmentUploading ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'æ·»ä»˜ã‚’è¿½åŠ ' }}
          </label>
          <p class="attachment-limit-message" *ngIf="attachmentLimitReached">
            æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€å¤§{{ attachmentLimit }}ä»¶ã¾ã§ã§ã™ã€‚
          </p>
        </div>
      </div>

      <p *ngIf="attachmentsLoading" class="placeholder-text">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>

      <div *ngIf="attachmentsError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentsError }}
      </div>

      <div *ngIf="attachmentUploadMessage" class="feedback feedback--success">
        <i class="icon-success" aria-hidden="true"></i>
        {{ attachmentUploadMessage }}
      </div>

      <div *ngIf="attachmentUploadError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentUploadError }}
      </div>

      <ul
        class="attachment-list"
        *ngIf="!attachmentsLoading && attachments.length > 0; else noAttachments"
      >
        <li
          class="attachment-item"
          *ngFor="let attachment of attachments; trackBy: trackAttachmentById"
        >
          <div class="attachment-main">
            <a
              class="attachment-name"
              [href]="attachment.fileUrl"
              target="_blank"
              rel="noopener"
            >
              {{ attachment.fileName }}
            </a>
            <span class="attachment-size">{{ formatFileSize(attachment.fileSize) }}</span>
          </div>
          <div class="attachment-meta">
            <span class="attachment-uploader">
              <ng-container *ngIf="attachment.uploaderPhotoUrl; else uploaderFallback">
                <img [src]="attachment.uploaderPhotoUrl" [alt]="attachment.uploaderLabel + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
              </ng-container>
              <ng-template #uploaderFallback>
                <span
                  class="attachment-uploader-fallback"
                  [style.backgroundColor]="getMemberAvatarColor(attachment.uploadedBy)"
                >
                  {{ getAttachmentInitial(attachment) }}
                </span>
              </ng-template>
              <span class="attachment-uploader-name">{{ attachment.uploaderLabel }}</span>
            </span>
            <time class="attachment-time">
              {{ attachment.uploadedAt ? (attachment.uploadedAt | date:'yyyy/MM/dd HH:mm') : '---' }}
            </time>
          </div>
          <button
            type="button"
            class="btn-icon btn-icon--labeled attachment-delete"
            *ngIf="canDeleteAttachment(attachment)"
            (click)="deleteAttachment(attachment)"
            [disabled]="attachmentDeletingId === attachment.id"
          >
            <i class="icon-delete" aria-hidden="true"></i>
            <span class="btn-label">{{ attachmentDeletingId === attachment.id ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤' }}</span>
          </button>
        </li>
      </ul>

      <ng-template #noAttachments>
        <p *ngIf="!attachmentsLoading && attachments.length === 0 && !attachmentsError" class="placeholder-text">
          æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚
        </p>
      </ng-template>
    </section>

    <section class="detail-section comments-section">
      <div class="comments-header">
        <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
        <span class="comments-count">{{ comments.length }}/500</span>
      </div>

      <div *ngIf="commentsLoading" class="comments-loading">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</div>
      <div *ngIf="commentError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ commentError }}
      </div>

      <div *ngIf="!commentsLoading && comments.length > 0" class="comments-list">
        <article class="comment-item" *ngFor="let comment of comments">
          <div class="comment-avatar">
            <ng-container *ngIf="comment.authorPhotoUrl; else commentAvatarFallback">
              <img [src]="comment.authorPhotoUrl" [alt]="comment.authorUsername + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
            </ng-container>
            <ng-template #commentAvatarFallback>
              <span class="comment-avatar-fallback" [style.backgroundColor]="getCommentAvatarColor(comment)">
                {{ getCommentInitial(comment) }}
              </span>
            </ng-template>
          </div>
          <div class="comment-body">
            <div class="comment-meta">
              <span class="comment-author">{{ comment.authorUsername }}</span>
              <time class="comment-time">{{ comment.createdAt | date:'yyyy/MM/dd HH:mm' }}</time>
            </div>
            <p class="comment-text">{{ comment.text }}</p>
            <div class="comment-mentions" *ngIf="comment.mentions?.length">
              <span class="mention-chip" *ngFor="let mentionId of comment.mentions">
                {{ '@' + getMentionLabel(mentionId) }}
              </span>
            </div>
          </div>
        </article>
      </div>
      <p *ngIf="!commentsLoading && comments.length === 0 && !commentError" class="placeholder-text">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

      <p *ngIf="commentLimitReached" class="comment-limit-message">ã‚³ãƒ¡ãƒ³ãƒˆæ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆæœ€å¤§500ä»¶ï¼‰ã€‚</p>

      <div class="comment-form" *ngIf="canPostComment(); else commentPermissionNotice">
        <textarea
          [(ngModel)]="commentForm.text"
          name="taskComment"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ï¼ˆæœ€å¤§5000æ–‡å­—ï¼‰"
          [maxlength]="5000"
          [disabled]="commentSubmitting || commentLimitReached"
          (input)="commentError = ''"
          aria-label="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"
        ></textarea>

        <div class="comment-form-footer">
          <div class="mention-selector" *ngIf="mentionableMembers.length > 0">
            <span class="mention-label">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³</span>
            <div class="mention-list">
              <button
                type="button"
                class="mention-option"
                *ngFor="let member of mentionableMembers"
                (click)="toggleMention(member)"
                [class.selected]="isMentionSelected(member.uid)"
              >
                <ng-container *ngIf="member.photoURL; else mentionAvatarFallback">
                  <span class="mention-avatar">
                    <img [src]="member.photoURL" [alt]="member.username + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
                  </span>
                </ng-container>
                <ng-template #mentionAvatarFallback>
                  <span class="mention-avatar-fallback" [style.backgroundColor]="getMemberAvatarColor(member.uid)">
                    {{ getMemberInitial(member) }}
                  </span>
                </ng-template>
                <span class="mention-name">{{ member.username }}</span>
                <span class="mention-check" *ngIf="isMentionSelected(member.uid)">âœ“</span>
              </button>
            </div>
          </div>

          <div class="comment-actions">
            <span class="char-count">{{ commentForm.text.length }}/5000</span>
            <button
              type="button"
              class="btn btn-primary"
              (click)="submitComment()"
              [disabled]="!canSubmitComment() || commentSubmitting"
            >
              {{ commentSubmitting ? 'æŠ•ç¨¿ä¸­...' : 'æŠ•ç¨¿' }}
            </button>
          </div>
        </div>
      </div>

      <ng-template #commentPermissionNotice>
        <p class="placeholder-text">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ç®¡ç†è€…ã¾ãŸã¯ãƒ¡ãƒ³ãƒãƒ¼æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</p>
      </ng-template>
    </section>
  </aside>
</div>