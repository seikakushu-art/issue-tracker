<!-- タスク詳細パネル -->
<div *ngIf="visible && task" class="task-detail-container">
  <div
    class="task-detail-backdrop"
    (click)="close()"
    (keydown.enter)="close()"
    (keydown.space)="close()"
    role="button"
    tabindex="0"
    aria-label="詳細を閉じる"
  ></div>
  <aside
    class="task-detail-panel"
    [style.borderTopColor]="getIssueThemeColor()"
    role="dialog"
    aria-modal="true"
  >
    <div class="detail-header">
      <div class="detail-title">
        <span class="importance-chip" [ngClass]="getImportanceClass(task.importance)">
          {{ getImportanceLabel(task.importance) }}
        </span>
        <h2>{{ task.title }}</h2>
      </div>
      <div class="detail-actions">
        <button class="btn btn-secondary btn-sm" *ngIf="canEditTask(task)" (click)="requestEdit()">
          編集
        </button>
        <button class="btn btn-secondary btn-sm" (click)="goToTaskDetail()">
          タスクへ
        </button>
        <button class="btn-icon" (click)="close()" aria-label="閉じる">
          <i class="icon-close"></i>
        </button>
      </div>
    </div>

    <p class="detail-description" *ngIf="task.description">{{ task.description }}</p>

    <section class="detail-section">
      <h3>基本情報</h3>
      <dl class="detail-meta">
        <div>
          <dt>ステータス</dt>
          <dd>
            <span class="status-badge" [class]="'status-' + task.status">
              {{ getStatusLabel(task.status) }}
            </span>
          </dd>
        </div>
        <div>
          <dt>重要度</dt>
          <dd>
            <span class="importance-chip" [ngClass]="getImportanceClass(task.importance)">
              {{ getImportanceLabel(task.importance) }}
            </span>
          </dd>
        </div>
        <div *ngIf="task.startDate">
          <dt>開始日</dt>
          <dd>{{ task.startDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="task.endDate">
          <dt>終了日</dt>
          <dd>{{ task.endDate | date:'yyyy/MM/dd' }}</dd>
        </div>
        <div *ngIf="task.goal" class="goal-item">
          <dt>達成目標</dt>
          <dd>{{ task.goal }}</dd>
        </div>
      </dl>
    </section>

    <section class="detail-section">
      <h3>進捗</h3>
      <div class="detail-progress">
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="getTaskProgress(task)"
            [style.background-color]="getIssueThemeColor()"
          ></div>
        </div>
        <span class="progress-value">{{ getTaskProgress(task) | number:'1.0-0' }}%</span>
      </div>
    </section>

    <section class="detail-section">
      <h3>チェックリスト</h3>
      <div *ngIf="task.checklist.length > 0; else emptyChecklist">
        <div class="detail-checklist-item" *ngFor="let item of task.checklist">
          <label>
            <input
              type="checkbox"
              [checked]="item.completed"
              [disabled]="!canEditTask(task)"
              (change)="toggleChecklistItem(item.id, $any($event.target).checked)"
            >
            <span [class.completed]="item.completed">{{ item.text }}</span>
          </label>
          <button
            type="button"
            class="btn-icon"
            *ngIf="canEditTask(task)"
            (click)="removeChecklistItem(item.id)"
            title="削除"
          >
            <i class="icon-delete"></i>
          </button>
        </div>
      </div>
      <ng-template #emptyChecklist>
        <p class="placeholder-text">チェックリストはまだありません。</p>
      </ng-template>
      <div class="detail-checklist-add">
        <input
          type="text"
          [(ngModel)]="newChecklistText"
          placeholder="新しい項目を入力"
          (keydown.enter)="addChecklistItem()"
          [disabled]="!canEditTask(task)"
        >
        <button type="button" class="btn btn-secondary btn-sm" (click)="addChecklistItem()" [disabled]="!canEditTask(task)">
          追加
        </button>
      </div>
    </section>

    <section class="detail-section" *ngIf="getVisibleTagIds(task).length > 0">
      <h3>タグ</h3>
      <div class="detail-tags">
        <span
        *ngFor="let tagId of getVisibleTagIds(task)"
          class="tag"
          [style.background-color]="getTagColor(tagId)"
        >
          {{ getTagName(tagId) }}
        </span>
      </div>
    </section>

    <section class="detail-section">
      <h3>担当者</h3>
      <p *ngIf="task.assigneeIds.length === 0" class="placeholder-text">担当者はまだ割り当てられていません。</p>
      <ul *ngIf="task.assigneeIds.length > 0" class="assignee-list">
        <li *ngFor="let assigneeId of task.assigneeIds" class="assignee-item">
          <ng-container *ngIf="getAssigneePhotoUrl(assigneeId) as photoUrl; else assigneeFallback">
            <span class="assignee-avatar assignee-avatar--image">
              <img [src]="photoUrl" [alt]="getAssigneeDisplayName(assigneeId) + 'のアイコン'">
            </span>
          </ng-container>
          <ng-template #assigneeFallback>
            <span
              class="assignee-avatar assignee-avatar--fallback"
              [style.backgroundColor]="getMemberAvatarColor(assigneeId)"
            >
              {{ getAssigneeInitial(assigneeId) }}
            </span>
          </ng-template>
          <span class="assignee-name">{{ getAssigneeDisplayName(assigneeId) }}</span>
        </li>
      </ul>
      <div
        *ngIf="assigneeActionMessage"
        class="feedback"
        [ngClass]="{
          'feedback--success': assigneeActionMessageType === 'success',
          'feedback--error': assigneeActionMessageType === 'error',
          'feedback--info': assigneeActionMessageType === 'info'
        }"
      >
        <i [class]="getAssigneeActionIcon()" aria-hidden="true"></i>
        {{ assigneeActionMessage }}
      </div>
    </section>

    <section class="detail-section attachments-section">
      <div class="section-header">
        <h3>添付</h3>
      </div>

      <p *ngIf="attachmentsLoading" class="placeholder-text">添付ファイルを読み込み中です...</p>

      <div *ngIf="attachmentsError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentsError }}
      </div>

      <div *ngIf="attachmentUploadMessage" class="feedback feedback--success">
        <i class="icon-success" aria-hidden="true"></i>
        {{ attachmentUploadMessage }}
      </div>

      <div *ngIf="attachmentUploadError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ attachmentUploadError }}
      </div>

      <ul
        class="attachment-list"
        *ngIf="!attachmentsLoading && attachments.length > 0; else noAttachments"
      >
        <li
          class="attachment-item"
          *ngFor="let attachment of attachments; trackBy: trackAttachmentById"
        >
          <div class="attachment-main">
            <a
              class="attachment-name"
              [href]="attachment.fileUrl"
              target="_blank"
              rel="noopener"
            >
              {{ attachment.fileName }}
            </a>
            <span class="attachment-size">{{ formatFileSize(attachment.fileSize) }}</span>
            <button
              type="button"
              class="btn-icon btn-icon--labeled attachment-delete"
              *ngIf="canDeleteAttachment(attachment)"
              (click)="deleteAttachment(attachment)"
              [disabled]="attachmentDeletingId === attachment.id"
            >
              <i class="icon-delete" aria-hidden="true"></i>
              <span class="btn-label">{{ attachmentDeletingId === attachment.id ? '削除中...' : '削除' }}</span>
            </button>
          </div>
          <div class="attachment-meta">
            <span class="attachment-uploader">
              <ng-container *ngIf="attachment.uploaderPhotoUrl; else uploaderFallback">
                <img [src]="attachment.uploaderPhotoUrl" [alt]="attachment.uploaderLabel + 'のアイコン'">
              </ng-container>
              <ng-template #uploaderFallback>
                <span
                  class="attachment-uploader-fallback"
                  [style.backgroundColor]="getMemberAvatarColor(attachment.uploadedBy)"
                >
                  {{ getAttachmentInitial(attachment) }}
                </span>
              </ng-template>
              <span class="attachment-uploader-name">{{ attachment.uploaderLabel }}</span>
            </span>
            <time class="attachment-time">
              {{ attachment.uploadedAt ? (attachment.uploadedAt | date:'yyyy/MM/dd HH:mm') : '---' }}
            </time>
          </div>
        </li>
      </ul>

      <ng-template #noAttachments>
        <p *ngIf="!attachmentsLoading && attachments.length === 0 && !attachmentsError" class="placeholder-text">
          添付ファイルはまだありません。
        </p>
      </ng-template>
    </section>

    <section class="detail-section comments-section">
      <div class="comments-header">
        <h3>コメント</h3>
        <span class="comments-count">{{ comments.length }}/500</span>
      </div>

      <div *ngIf="commentsLoading" class="comments-loading">コメントを読み込み中です...</div>
      <div *ngIf="commentError" class="feedback feedback--error">
        <i class="icon-error" aria-hidden="true"></i>
        {{ commentError }}
      </div>

      <div *ngIf="!commentsLoading && comments.length > 0" class="comments-list">
        <article class="comment-item" *ngFor="let comment of comments">
          <div class="comment-avatar">
            <ng-container *ngIf="comment.authorPhotoUrl; else commentAvatarFallback">
              <img [src]="comment.authorPhotoUrl" [alt]="comment.authorUsername + 'のアイコン'">
            </ng-container>
            <ng-template #commentAvatarFallback>
              <span class="comment-avatar-fallback" [style.backgroundColor]="getCommentAvatarColor(comment)">
                {{ getCommentInitial(comment) }}
              </span>
            </ng-template>
          </div>
          <div class="comment-body">
            <div class="comment-meta">
              <span class="comment-author">{{ comment.authorUsername }}</span>
              <time class="comment-time">{{ comment.createdAt | date:'yyyy/MM/dd HH:mm' }}</time>
            </div>
            <p class="comment-text">
              <ng-container *ngFor="let segment of parseCommentText(comment.text, comment.mentions || [])">
                <ng-container *ngIf="segment.type === 'text'">{{ segment.content }}</ng-container>
                <span *ngIf="segment.type === 'mention'" class="mention-chip">
                  {{ segment.content }}
                </span>
              </ng-container>
            </p>
          </div>
        </article>
      </div>
      <p *ngIf="!commentsLoading && comments.length === 0 && !commentError" class="placeholder-text">まだコメントはありません。</p>

      <p *ngIf="commentLimitReached" class="comment-limit-message">コメント数が上限に達しました（最大500件）。</p>

      <div class="comment-form" *ngIf="canPostComment(); else commentPermissionNotice">
        <textarea
          [(ngModel)]="commentForm.text"
          name="taskComment"
          placeholder="コメントを入力（最大5000文字）"
          [maxlength]="5000"
          [disabled]="commentSubmitting || commentLimitReached"
          (input)="commentError = ''"
          aria-label="コメントを入力"
        ></textarea>

        <div class="comment-form-footer">
          <div class="comment-form-toolbar">
            <button
              type="button"
              class="btn btn-secondary btn-sm mention-toggle"
              (click)="toggleMentionSelector()"
              [disabled]="mentionableMembers.length === 0"
              aria-haspopup="listbox"
              [attr.aria-expanded]="mentionSelectorOpen"
              [attr.aria-controls]="mentionSelectorPanelId"
            >
              <span class="mention-toggle-icon">&#64;</span>
              <span class="mention-toggle-label">メンション</span>
            </button>
            <span class="mention-helper" *ngIf="mentionableMembers.length === 0">
              メンションできるメンバーがいません。
            </span>
          </div>

          <div
            class="mention-selector"
            *ngIf="mentionSelectorOpen && mentionableMembers.length > 0"
            [attr.id]="mentionSelectorPanelId"
            role="listbox"
            aria-label="メンション候補"
          >
            <p class="mention-helper-text">タスクの所属プロジェクトのメンバーだけが表示されます。</p>
            <div class="mention-list">
              <button
                type="button"
                class="mention-option"
                *ngFor="let member of mentionableMembers"
                (click)="toggleMention(member)"
                [class.selected]="isMentionSelected(member.uid)"
              >
                <ng-container *ngIf="member.photoURL; else mentionAvatarFallback">
                  <span class="mention-avatar">
                    <img [src]="member.photoURL" [alt]="member.username + 'のアイコン'">
                  </span>
                </ng-container>
                <ng-template #mentionAvatarFallback>
                  <span class="mention-avatar-fallback" [style.backgroundColor]="getMemberAvatarColor(member.uid)">
                    {{ getMemberInitial(member) }}
                  </span>
                </ng-template>
                <span class="mention-name">{{ member.username }}</span>
                <span class="mention-check" *ngIf="isMentionSelected(member.uid)">✓</span>
              </button>
            </div>
          </div>

          <div class="comment-actions">
            <span class="char-count">{{ commentForm.text.length }}/5000</span>
            <button
              type="button"
              class="btn btn-primary"
              (click)="submitComment()"
              [disabled]="!canSubmitComment() || commentSubmitting"
            >
              {{ commentSubmitting ? '投稿中...' : '投稿' }}
            </button>
          </div>
        </div>
      </div>

      <ng-template #commentPermissionNotice>
        <p class="placeholder-text">コメントを投稿するには管理者またはメンバー権限が必要です。</p>
      </ng-template>
    </section>
  </aside>
</div>