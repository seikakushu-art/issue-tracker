<div class="gantt-wrapper">
  <header class="gantt-header">
    <div class="gantt-header__titles">
      <h1>進行状況（ガントチャート）</h1>
      <p class="gantt-header__caption">課題とタスクの進捗を時系列で確認できます。</p>
      <div class="gantt-controls">
        <div class="gantt-controls__nav" aria-label="タイムラインの移動">
          <button type="button" class="gantt-controls__nav-btn" (click)="scrollByWeeks(-4)" aria-label="4週間戻る">
            <span aria-hidden="true">‹</span>
          </button>
          <button type="button" class="gantt-controls__nav-btn" (click)="scrollByWeeks(4)" aria-label="4週間進む">
            <span aria-hidden="true">›</span>
          </button>
        </div>
        <div class="gantt-controls__jump" aria-label="月単位の移動">
          <button type="button" class="gantt-controls__jump-btn" (click)="scrollByMonths(-1)">先月</button>
          <button type="button" class="gantt-controls__today" (click)="scrollToToday()">今日</button>
          <button type="button" class="gantt-controls__jump-btn" (click)="scrollByMonths(1)">来月</button>
        </div>
        <div class="gantt-controls__meta">
          <span class="gantt-controls__month">{{ activeMonthLabel }}</span>
          <span class="gantt-controls__hint">タイムラインは過去・未来5年までスクロールできます。</span>
        </div>
        <div class="gantt-controls__filter" *ngIf="availableProjects.length > 0">
          <span class="gantt-controls__filter-label">表示プロジェクト</span>
          <label class="gantt-controls__filter-option">
            <input
              type="checkbox"
              [checked]="areAllProjectsSelected()"
              (change)="handleProjectSelectAll($event)"
            />
            <span>すべて</span>
          </label>
          <div class="gantt-controls__filter-list">
            <label
              class="gantt-controls__filter-option"
              *ngFor="let project of availableProjects; trackBy: trackByProjectId"
            >
              <input
                type="checkbox"
                [checked]="isProjectSelected(project.id)"
                (change)="handleProjectFilterChange(project.id, $event)"
              />
              <span>{{ project.name }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    <button class="gantt-header__refresh" type="button" (click)="loadData()" [disabled]="loading">
      <i class="icon-rotate"></i>
      <span>最新の状態を取得</span>
    </button>
  </header>

  <div class="gantt-layout">

    <div class="gantt-main">
      <section *ngIf="loadError" class="gantt-error" role="alert">
        <i class="icon-alert"></i>
        {{ loadError }}
      </section>

      <section *ngIf="loading" class="gantt-loading">
        <div class="spinner"></div>
        <span>読み込み中...</span>
      </section>

      <section
        *ngIf="!loading && !loadError"
        class="gantt-content"
        [style.--day-width.px]="dayCellWidth"
        [style.--label-width.px]="labelColumnWidth"
      >
        <div class="gantt-grid">
          <app-progress-gantt-timeline
          [timeline]="timeline"
          [timelineMonths]="timelineMonths"
          [gridTemplate]="getGridTemplate()"
          [labelColumnWidth]="labelColumnWidth"
          [dayCellWidth]="dayCellWidth"
          (scrolled)="onTimelineScroll($event)"
        >

            <div class="gantt-grid__rows">
              <ng-container *ngIf="visibleGanttIssues.length > 0; else emptyState">
                <ng-container *ngFor="let group of visibleGanttIssues">
                  <div class="gantt-row-line issue" [style.gridTemplateColumns]="'var(--label-width) ' + getGridTemplate()">
                    <div class="gantt-row__label issue" [style.borderLeftColor]="getIssueTheme(group.issue)">
                      <button class="issue-toggle" type="button" (click)="toggleIssue(group)" [attr.aria-expanded]="!group.collapsed">
                        <i class="icon-chevron" [class.collapsed]="group.collapsed"></i>
                        <span class="issue-name">{{ group.issue.name }}</span>
                      </button>
                      <p class="issue-meta">{{ group.project.name }} / タスク {{ group.tasks.length }} 件</p>
                    </div>
                    <div class="gantt-row__chart issue" [style.gridTemplateColumns]="getGridTemplate()">
                      <div
                      *ngFor="let day of timeline"
                      class="gantt-cell"
                      [class.weekend]="day.isWeekend"
                      [class.holiday]="day.isHoliday"
                    ></div>
                    </div>
                  </div>

                  <div
                    class="gantt-row-line task"
                    *ngFor="let task of group.tasks"
                    [class.collapsed]="group.collapsed"
                    [style.gridTemplateColumns]="'var(--label-width) ' + getGridTemplate()"
                  >
                    <div
                      class="gantt-row__label"
                      role="button"
                      tabindex="0"
                      (click)="selectTask(group, task)"
                      (keydown.enter)="selectTask(group, task)"
                      (keydown.space)="selectTask(group, task)"
                    >
                      <span class="task-title">{{ task.title }}</span>
                      <span class="task-meta">{{ getTaskStatusLabel(task) }} / {{ getImportanceLabel(task) }}</span>
                    </div>
                    <div class="gantt-row__chart" [style.gridTemplateColumns]="getGridTemplate()">
                      <div
                        *ngFor="let day of timeline"
                        class="gantt-cell"
                        [class.weekend]="day.isWeekend"
                        [class.holiday]="day.isHoliday"
                        [class.today]="day.isToday"
                      ></div>
                      <button
                        type="button"
                        class="gantt-bar"
                        [style.backgroundColor]="getIssueTheme(group.issue)"
                        [style.left]="getTaskOffset(task)"
                        [style.width]="getTaskWidth(task)"
                        (click)="selectTask(group, task)"
                      >
                        <span class="gantt-bar__label">{{ task.title }}</span>
                      </button>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
              <ng-template #emptyState>
                <div class="gantt-empty">
                  <i class="icon-calendar"></i>
                  <p>表示できるタスクがありません。プロジェクトの課題とタスクを作成するとガントチャートに表示されます。</p>
                </div>
              </ng-template>
            </div>
          </app-progress-gantt-timeline>
        </div>
      </section>
    </div>
  </div>

  <aside *ngIf="selectedTask as task" class="task-detail-panel" role="dialog" aria-modal="true">
      <div
        class="task-detail__backdrop"
        role="button"
        tabindex="0"
        aria-label="詳細を閉じる"
        (click)="closeDetailPanel()"
        (keydown.enter)="closeDetailPanel()"
        (keydown.space)="closeDetailPanel()"
      ></div>
      <div class="task-detail__body">
        <header class="task-detail__header">
          <h2>{{ task.title }}</h2>
          <button type="button" class="btn-close" (click)="closeDetailPanel()" aria-label="閉じる">
            <i class="icon-close"></i>
          </button>
        </header>
        <section class="task-detail__section">
          <h3>基本情報</h3>
          <dl>
            <div>
              <dt>所属</dt>
              <dd>{{ selectedProject?.name || '未設定のプロジェクト' }} / {{ selectedIssue?.name || '未設定の課題' }}</dd>
            </div>
            <div>
              <dt>ステータス</dt>
              <dd>{{ getTaskStatusLabel(task) }}</dd>
            </div>
            <div>
              <dt>重要度</dt>
              <dd>{{ getImportanceLabel(task) }}</dd>
            </div>
            <div *ngIf="task.startDate">
              <dt>開始日</dt>
              <dd>{{ task.startDate | date:'yyyy/MM/dd':tokyoTimezone:'ja-JP' }}</dd>
            </div>
            <div *ngIf="task.endDate">
              <dt>終了日</dt>
              <dd>{{ task.endDate | date:'yyyy/MM/dd':tokyoTimezone:'ja-JP' }}</dd>
            </div>
          </dl>
        </section>
        <section class="task-detail__section" *ngIf="task.goal">
          <h3>達成目標</h3>
          <p>{{ task.goal }}</p>
        </section>
        <section class="task-detail__section" *ngIf="task.description">
          <h3>説明</h3>
          <p class="task-detail__description">{{ task.description }}</p>
        </section>
        <div class="task-detail__actions">
          <button type="button" class="btn-primary" (click)="goToTaskDetail()">
            <i class="icon-open"></i>
            <span>タスク詳細で開く</span>
          </button>
        </div>
      </div>
    </aside>
  </div>