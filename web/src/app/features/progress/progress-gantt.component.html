<div class="gantt-wrapper">
  <header class="gantt-header">
    <div class="gantt-header__titles">
      <h1>進行状況（ガントチャート）</h1>
      <p class="gantt-header__caption">課題とタスクの進捗を時系列で確認できます。</p>
      <div class="gantt-controls">
        <div class="gantt-controls__nav" aria-label="タイムラインの移動">
          <button type="button" class="gantt-controls__nav-btn" (click)="scrollByWeeks(-4)" aria-label="4週間戻る">
            <span aria-hidden="true">‹</span>
          </button>
          <button type="button" class="gantt-controls__nav-btn" (click)="scrollByWeeks(4)" aria-label="4週間進む">
            <span aria-hidden="true">›</span>
          </button>
        </div>
        <div class="gantt-controls__jump" aria-label="月単位の移動">
          <button type="button" class="gantt-controls__jump-btn" (click)="scrollByMonths(-1)">先月</button>
          <button type="button" class="gantt-controls__today" (click)="scrollToToday()">今日</button>
          <button type="button" class="gantt-controls__jump-btn" (click)="scrollByMonths(1)">来月</button>
        </div>
        <div class="gantt-controls__meta">
          <div class="gantt-controls__meta-row">
            <span class="gantt-controls__month">{{ activeMonthLabel }}</span>
            <label
              class="gantt-controls__project-select"
              *ngIf="availableProjects.length > 0"
            >
              <span class="gantt-controls__project-select-label">プロジェクト</span>
              <select
                class="gantt-controls__project-select-input"
                (change)="handleProjectSelectChange($event)"
                [value]="selectedProjectId ?? ''"
              >
                <option value="">プロジェクトを選択</option>
                <option
                  *ngFor="let project of availableProjects; trackBy: trackByProjectId"
                  [value]="project.id ?? ''"
                >
                  {{ project.name }}
                </option>
              </select>
            </label>
          </div>
          <span class="gantt-controls__hint">タイムラインは過去・未来5年までスクロールできます。</span>
        </div>
      </div>
    </div>
    <button class="gantt-header__refresh" type="button" (click)="loadData()" [disabled]="loading">
      <i class="icon-rotate"></i>
      <span>最新の状態を取得</span>
    </button>
  </header>

  <div class="gantt-layout">

    <div class="gantt-main">
      <section *ngIf="loadError" class="gantt-error" role="alert">
        <i class="icon-alert"></i>
        {{ loadError }}
      </section>

      <section *ngIf="loading" class="gantt-loading">
        <div class="spinner"></div>
        <span>読み込み中...</span>
      </section>

      <section
        *ngIf="!loading && !loadError"
        class="gantt-content"
        [style.--day-width.px]="dayCellWidth"
        [style.--label-width.px]="labelColumnWidth"
      >
        <div class="gantt-grid">
          <app-progress-gantt-timeline
          [timeline]="timeline"
          [timelineMonths]="timelineMonths"
          [gridTemplate]="getGridTemplate()"
          [labelColumnWidth]="labelColumnWidth"
          [dayCellWidth]="dayCellWidth"
          [highlightedDayIndex]="hoveredDayIndex"
          [highlightedTaskRange]="hoveredTaskRange"
          (scrolled)="onTimelineScroll($event)"
          (dayHoverChange)="handleTimelineDayHover($event)"
        >

          
        <ng-container *ngIf="shouldShowProjectSelectionHint; else ganttRows">
          <div class="gantt-grid__selection-hint" role="status" aria-live="polite">
            <i class="icon-info"></i>
            <p>プロジェクトを選択してください</p>
          </div>
        </ng-container>
        <ng-template #ganttRows>
          <div class="gantt-grid__rows">
            <ng-container *ngIf="visibleGanttIssues.length > 0; else emptyState">
              <ng-container *ngFor="let group of visibleGanttIssues">
                <div
                  class="gantt-row-line issue"
                  [style.gridTemplateColumns]="'var(--label-width) ' + getGridTemplate()"
                  [style.--issue-theme-color]="getIssueTheme(group.issue)"
                  [style.--issue-theme-soft]="getIssueSurfaceColor(group.issue)"
                  [style.--issue-theme-overlay]="getIssueOverlayColor(group.issue)"
                >
                  <div class="gantt-row__label issue">
                    <button class="issue-toggle" type="button" (click)="toggleIssue(group)" [attr.aria-expanded]="!group.collapsed">
                      <i class="icon-chevron" [class.collapsed]="group.collapsed"></i>
                      <span class="issue-name" [title]="group.issue.name">{{ group.issue.name }}</span>
                    </button>
                  </div>
                  <div class="gantt-row__chart issue" [style.gridTemplateColumns]="getGridTemplate()">
                    <div
                    *ngFor="let day of timeline; index as dayIndex"
                        class="gantt-cell"
                        [class.weekend]="day.isWeekend"
                        [class.holiday]="day.isHoliday"
                        [class.today]="day.isToday"
                        [class.is-highlighted]="isDayHighlighted(dayIndex)"
                        (mouseenter)="handleTimelineCellHover(dayIndex)"
                        (mouseleave)="handleTimelineCellHover(null)"
                      ></div>
                    </div>
                  </div>

                  <div
                    class="gantt-row-line task"
                    *ngFor="let task of group.tasks"
                    [class.collapsed]="group.collapsed"
                    [style.gridTemplateColumns]="'var(--label-width) ' + getGridTemplate()"
                    [style.--task-theme-color]="getTaskTheme(task, group.issue)"
                    [style.--task-theme-soft]="getTaskSurfaceColor(task, group.issue)"
                    [style.--task-theme-overlay]="getTaskOverlayColor(task, group.issue)"
                  >
                    <div
                      class="gantt-row__label"
                      role="button"
                      tabindex="0"
                        (click)="selectTask(group, task)"
                        (keydown.enter)="selectTask(group, task)"
                        (keydown.space)="selectTask(group, task)"
                        (mouseenter)="handleTaskHover(task)"
                        (mouseleave)="handleTaskHover(null)"
                        [class.is-highlighted]="isTaskHighlighted(task)"
                      >
                      <div class="task-label">
                        <span class="task-color-indicator" aria-hidden="true"></span>
                        <span class="task-title" [title]="task.title">{{ task.title }}</span>
                      </div>
                      </div>
                      <div class="gantt-row__chart" [style.gridTemplateColumns]="getGridTemplate()">
                        <div
                        *ngFor="let day of timeline; index as dayIndex"
                          class="gantt-cell"
                          [class.weekend]="day.isWeekend"
                          [class.holiday]="day.isHoliday"
                          [class.today]="day.isToday"
                          [class.is-highlighted]="isDayHighlighted(dayIndex)"
                          (mouseenter)="handleTimelineCellHover(dayIndex)"
                          (mouseleave)="handleTimelineCellHover(null)"
                        ></div>
                        <button
                          *ngIf="hasValidTaskPeriod(task)"
                          type="button"
                          class="gantt-bar"
                          [style.backgroundColor]="getTaskTheme(task, group.issue)"
                          [style.left]="getTaskOffset(task)"
                          [style.width]="getTaskWidth(task)"
                          (click)="selectTask(group, task)"
                          (mouseenter)="handleTaskHover(task)"
                          (mouseleave)="handleTaskHover(null)"
                          [class.is-highlighted]="isTaskHighlighted(task)"
                        >
                          <span class="gantt-bar__label">{{ task.title }}</span>
                        </button>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>
                <ng-template #emptyState>
                  <div class="gantt-empty">
                    <i class="icon-calendar"></i>
                    <p>表示できるタスクがありません。プロジェクトの課題とタスクを作成するとガントチャートに表示されます。</p>
                  </div>
                </ng-template>
              </div>
            </ng-template>
          </app-progress-gantt-timeline>
        </div>
      </section>
    </div>
  </div>
  <app-task-detail-panel
    *ngIf="selectedTask?.id && selectedIssue?.id && selectedProject?.id"
    [visible]="selectedTask !== null"
    [projectId]="selectedProject?.id ?? null"
    [issueId]="selectedIssue?.id ?? null"
    [taskId]="selectedTask?.id ?? null"
    [allowEditing]="true"
    (closed)="closeDetailPanel()"
    (taskChanged)="handleTaskDetailUpdate($event)"
  ></app-task-detail-panel>
</div>