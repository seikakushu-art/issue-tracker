<div class="tree-wrapper">
    <header class="tree-header">
      <div class="tree-header__titles">
        <h1>進行状況（ツリー）</h1>
        <p class="tree-header__caption">
          プロジェクト → 課題 → タスクの階層のツリー表示です。
        </p>
      </div>
      <div class="tree-header__actions">
        <label class="tree-header__filter">
          <span class="tree-header__filter-label">表示プロジェクト</span>
          <select [ngModel]="projectFilterId" (ngModelChange)="onProjectFilterChange($event)">
            <option *ngFor="let option of projectFilterOptions" [value]="option.id">{{ option.label }}</option>
          </select>
        </label>
        <button class="tree-header__refresh" type="button" (click)="loadData()" [disabled]="loading">
          <i class="icon-rotate"></i>
          <span>最新の状態を取得</span>
        </button>
      </div>
    </header>
  
    <section *ngIf="loadError" class="tree-error" role="alert">
      <i class="icon-alert"></i>
      {{ loadError }}
    </section>
  
    <section *ngIf="sampleNotice" class="tree-notice" role="status">
      <i class="icon-info"></i>
      {{ sampleNotice }}
    </section>
  
    <section *ngIf="loading" class="tree-loading">
      <div class="spinner"></div>
      <span>読み込み中...</span>
    </section>
  
    <section *ngIf="!loading" class="tree-content">
      <div class="tree-panel" role="tree">
        <ng-container *ngIf="displayedTreeProjects.length > 0; else emptyState">
          <div *ngFor="let project of displayedTreeProjects" class="tree-node project" [attr.aria-expanded]="!project.collapsed">
            <div class="tree-node__header">
              <button type="button" class="toggle" (click)="toggleProject(project)">
                <i class="icon-chevron" [class.collapsed]="project.collapsed"></i>
              </button>
              <div class="tree-node__info">
                <span class="tree-node__label">{{ project.project.name }}</span>
                <span class="tree-node__meta">課題 {{ project.issues.length }} 件</span>
              </div>
              <span class="tree-node__progress" *ngIf="project.project.progress !== undefined">{{ project.project.progress }}%</span>
            </div>
  
            <div class="tree-children" [class.collapsed]="project.collapsed">
              <div *ngFor="let issue of project.issues" class="tree-node issue" [attr.aria-expanded]="!issue.collapsed">
                <div class="tree-node__header">
                  <button type="button" class="toggle" (click)="toggleIssue(issue)">
                    <i class="icon-chevron" [class.collapsed]="issue.collapsed"></i>
                  </button>
                  <div class="tree-node__info">
                    <span class="tree-node__label">
                      <span class="color-dot" [style.backgroundColor]="issue.issue.themeColor || '#475569'"></span>
                      {{ issue.issue.name }}
                    </span>
                    <span class="tree-node__meta">タスク {{ issue.tasks.length }} 件</span>
                  </div>
                  <span class="tree-node__progress" *ngIf="issue.issue.progress !== undefined">{{ issue.issue.progress }}%</span>
                </div>
  
                <div class="tree-children" [class.collapsed]="issue.collapsed">
                  <div *ngFor="let treeTask of issue.tasks" class="tree-node task" role="treeitem" aria-selected="false" tabindex="0" (click)="selectTask(project, issue, treeTask)" (keydown.enter)="selectTask(project, issue, treeTask)" (keydown.space)="selectTask(project, issue, treeTask)">
                    <div class="task-body">
                      <div class="task-main">
                        <span class="status-badge" [class]="'status-badge ' + getStatusClass(treeTask.task)">{{ getTaskStatusLabel(treeTask.task) }}</span>
                        <span class="task-title">{{ treeTask.task.title }}</span>
                      </div>
                      <div class="task-sub">
                        <span>{{ getImportanceLabel(treeTask.task) }}</span>
                        <span *ngIf="treeTask.task.startDate">{{ treeTask.task.startDate | date:'yyyy/MM/dd':tokyoTimezone:'ja-JP' }}</span>
                        <span *ngIf="treeTask.task.endDate">→ {{ treeTask.task.endDate | date:'yyyy/MM/dd':tokyoTimezone:'ja-JP' }}</span>
                      </div>
                      <div class="dependency-visual" *ngIf="hasDependencies(treeTask)">
                        <div class="dependency-group" *ngIf="treeTask.dependencies.length > 0">
                          <span class="dependency-label predecessor"><i class="icon-branch-in"></i> 依存元</span>
                          <ul>
                            <li *ngFor="let dep of treeTask.dependencies" [title]="dep.label">
                              <i class="icon-link"></i>
                              <span>{{ dep.label }}</span>
                            </li>
                          </ul>
                        </div>
                        <div class="dependency-group" *ngIf="treeTask.dependents.length > 0">
                          <span class="dependency-label successor"><i class="icon-branch-out"></i> 依存先</span>
                          <ul>
                            <li *ngFor="let dep of treeTask.dependents" [title]="dep.label">
                              <i class="icon-link"></i>
                              <span>{{ dep.label }}</span>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </section>
  
    <ng-template #emptyState>
      <div class="tree-empty">
        <i class="icon-tree"></i>
        <p>表示できるデータがありません。プロジェクトに課題とタスクを追加するとツリーに表示されます。</p>
      </div>
    </ng-template>
  </div>