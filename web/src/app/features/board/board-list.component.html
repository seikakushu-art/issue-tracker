<section class="board" aria-labelledby="board-page-title">
    <div class="board__header">
      <h1 id="board-page-title">掲示板</h1>
      <p class="board__description">
        所属プロジェクト向けのお知らせを共有できます。
      </p>
    </div>
  
    <section class="board__form" aria-labelledby="board-form-title">
      <div class="board__form-header">
        <h2 id="board-form-title">新規投稿</h2>
        <p class="board__form-hint">管理者・メンバーのみ投稿できます。</p>
      </div>
  
      <ng-container *ngIf="hasPostPermission(); else noPermission">
        <form (ngSubmit)="submit()" novalidate>
          <div class="form-field">
            <label for="board-title-input">タイトル<span aria-hidden="true" class="form-field__required">*</span></label>
            <input
              id="board-title-input"
              type="text"
              name="title"
              [(ngModel)]="postForm.title"
              [disabled]="submitting()"
              required
              maxlength="120"
              placeholder="タイトルを入力してください"
            />
          </div>
  
          <div class="form-field">
            <label for="board-content-input">内容<span aria-hidden="true" class="form-field__required">*</span></label>
            <textarea
              id="board-content-input"
              name="content"
              rows="6"
              [(ngModel)]="postForm.content"
              [disabled]="submitting()"
              required
              maxlength="20000"
              placeholder="共有したい内容を記載してください"
            ></textarea>
          </div>
  
          <div class="form-field">
            <span class="form-field__label">対象プロジェクト<span aria-hidden="true" class="form-field__required">*</span></span>
            <div class="form-field__checkboxes" role="group" aria-describedby="project-help">
              <label *ngFor="let project of postableProjects()" class="checkbox-option">
                <input
                  type="checkbox"
                  [value]="project.id"
                  (change)="onProjectCheckboxChange(project.id, $event)"
                  [checked]="isProjectSelected(project.id)"
                  [disabled]="submitting()"
                />
                <span>{{ project.name }}</span>
              </label>
            </div>
            <p id="project-help" class="form-field__help">最大5件まで選択できます。</p>
          </div>
  
          <p class="form-message form-message--error" *ngIf="formError()">{{ formError() }}</p>
          <p class="form-message form-message--success" *ngIf="successMessage()">{{ successMessage() }}</p>
  
          <div class="form-actions">
            <button type="submit" class="button" [disabled]="!canSubmit()">投稿する</button>
          </div>
        </form>
      </ng-container>
  
      <ng-template #noPermission>
        <p class="board__no-permission">
          投稿権限を持つプロジェクトに所属していません。管理者から権限付与を依頼してください。
        </p>
      </ng-template>
    </section>
  
    <section class="board__posts" id="board-posts-section" aria-labelledby="board-posts-title">
      <div class="board__posts-header">
        <h2 id="board-posts-title">最新の投稿</h2>
      </div>
  
      <div class="board__posts-loading" *ngIf="loadingPosts()">
        <span class="spinner" aria-hidden="true"></span>
        <span>読み込み中...</span>
      </div>
  
      <p class="board__posts-error" *ngIf="!loadingPosts() && postsError()">{{ postsError() }}</p>
      <p class="board__posts-empty" *ngIf="!loadingPosts() && !postsError() && posts().length === 0">
        閲覧可能な投稿はまだありません。
      </p>
      <p class="board__posts-warning" *ngIf="!loadingPosts() && !postsError() && hasMorePosts()">
        ⚠️ 閲覧可能な投稿が500件を超えています。最新の500件のみ表示しています。それより古い投稿を確認するには、不要な投稿を削除してください。
      </p>
  
      <div class="board__pagination" *ngIf="!loadingPosts() && !postsError() && totalPages() > 1">
        <button
          type="button"
          class="pagination-button"
          (click)="previousPage()"
          [disabled]="currentPage() === 1"
          aria-label="前のページ"
        >
          前へ
        </button>
        <span class="pagination-info">
          {{ currentPage() }} / {{ totalPages() }} ページ
          (全 {{ allPosts().length }} 件)
        </span>
        <button
          type="button"
          class="pagination-button"
          (click)="nextPage()"
          [disabled]="currentPage() === totalPages()"
          aria-label="次のページ"
        >
          次へ
        </button>
      </div>

      <ul class="board__posts-list" *ngIf="!loadingPosts() && !postsError() && posts().length > 0">
        <li class="board-post" *ngFor="let post of posts(); trackBy: trackByPostId" [attr.id]="'post-' + post.id">
          <header class="board-post__header">
            <div class="board-post__author">
              <ng-container *ngIf="post.authorPhotoUrl; else authorFallback">
                <img
                  [src]="post.authorPhotoUrl"
                  class="board-post__avatar"
                  [alt]="post.authorUsername + 'のアイコン'"
                />
              </ng-container>
              <ng-template #authorFallback>
                <span
                  class="board-post__avatar board-post__avatar--fallback"
                  [style.backgroundColor]="getAvatarColor(post.authorId)"
                >
                  {{ getAvatarInitial(post.authorUsername || post.authorId) }}
                </span>
              </ng-template>
              <div class="board-post__author-meta">
                <span class="board-post__author-name">{{ post.authorUsername }}</span>
                <time
                  class="board-post__timestamp"
                  [attr.datetime]="post.createdAt ? post.createdAt.toISOString() : ''"
                >
                  {{ post.createdAt ? (post.createdAt | date: 'yyyy/MM/dd HH:mm') : '日時不明' }}
                </time>
              </div>
            </div>
            <div class="board-post__header-right">
              <ul class="board-post__projects">
                <li *ngFor="let name of post.projectNames">{{ name }}</li>
              </ul>
              <button
                *ngIf="isMyPost(post)"
                type="button"
                class="board-post__delete-button"
                (click)="deletePost(post.id)"
                [disabled]="isDeletingPost(post.id)"
                [attr.aria-label]="'投稿「' + post.title + '」を削除'"
                title="投稿を削除"
              >
                <span *ngIf="!isDeletingPost(post.id)">削除</span>
                <span *ngIf="isDeletingPost(post.id)">削除中...</span>
              </button>
            </div>
          </header>
          <h3 class="board-post__title">{{ post.title }}</h3>
          <div class="board-post__content-wrapper">
            <p
              class="board-post__content"
              [class.board-post__content--expanded]="isPostExpanded(post.id)"
            >
              {{ post.content }}
            </p>
            <button
              *ngIf="post.content && post.content.length > 200"
              type="button"
              class="board-post__expand-button"
              (click)="togglePostExpansion(post.id)"
              [attr.aria-expanded]="isPostExpanded(post.id)"
            >
              {{ isPostExpanded(post.id) ? '折りたたむ' : '全文を表示' }}
            </button>
          </div>
        </li>
      </ul>

      <div class="board__pagination board__pagination--bottom" *ngIf="!loadingPosts() && !postsError() && totalPages() > 1">
        <button
          type="button"
          class="pagination-button"
          (click)="previousPage()"
          [disabled]="currentPage() === 1"
          aria-label="前のページ"
        >
          前へ
        </button>
        <span class="pagination-info">
          {{ currentPage() }} / {{ totalPages() }} ページ
          (全 {{ allPosts().length }} 件)
        </span>
        <button
          type="button"
          class="pagination-button"
          (click)="nextPage()"
          [disabled]="currentPage() === totalPages()"
          aria-label="次のページ"
        >
          次へ
        </button>
      </div>
    </section>
  </section>