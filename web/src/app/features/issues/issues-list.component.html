<div class="issues-layout">
  <!-- å·¦å´å›ºå®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <app-project-sidebar [currentProjectId]="projectId"></app-project-sidebar>

  <!-- å³å´ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ ï¼ˆæ—¢å­˜ã®èª²é¡Œä¸€è¦§UIï¼‰ -->
  <div class="issues-container">
  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ä¸¦ã³æ›¿ãˆ -->
  <section *ngIf="projectDetails" class="project-summary">
    <div class="summary-header">
      <div class="summary-title">
        <h3><span class="project-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span> <span class="project-name">{{ projectDetails.name }}</span></h3>
        <p class="summary-goal" *ngIf="projectDetails.goal"><span class="goal-label">é”æˆç›®æ¨™:</span> <span class="goal-content">{{ projectDetails.goal }}</span></p>
      </div>
      <div class="summary-dates">
        <span *ngIf="projectDetails.startDate">é–‹å§‹: {{ projectDetails.startDate | date:'yyyy/MM/dd' }}</span>
        <span *ngIf="projectDetails.endDate">çµ‚äº†: {{ projectDetails.endDate | date:'yyyy/MM/dd' }}</span>
      </div>
    </div>

    <p class="summary-description" *ngIf="projectDetails.description">{{ projectDetails.description }}</p>

    <div class="summary-progress">
      <span class="label">é€²æ—</span>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="projectDetails.progress || 0"></div>
      </div>
      <span class="value">{{ projectDetails.progress || 0 }}%</span>
    </div>

    <div class="summary-meta">
      <span>ãƒ¡ãƒ³ãƒãƒ¼: {{ projectDetails.memberIds.length }}äºº</span>
      <span>èª²é¡Œæ•°: {{ filteredIssues.length }}</span>
    </div>
    <div class="summary-members" *ngIf="projectDetails.memberIds.length > 0">
      <span class="summary-members__label">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</span>
      <div class="summary-members__avatars" aria-label="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼">
        <ng-container *ngFor="let memberId of getVisibleMemberIds(projectDetails.memberIds); let i = index">
          <ng-container *ngIf="getMemberPhoto(memberId) as photoUrl; else issueMemberFallback">
            <span
              class="summary-avatar summary-avatar--image"
              [attr.title]="getMemberLabel(memberId, i)"
              [attr.aria-label]="getMemberLabel(memberId, i)"
            >
              <img
                class="summary-avatar__image"
                [src]="photoUrl"
                [alt]="getMemberDisplayName(memberId) + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'"
              >
            </span>
          </ng-container>
          <ng-template #issueMemberFallback>
            <span
              class="summary-avatar"
              [style.background]="getMemberColor(memberId)"
              [attr.title]="getMemberLabel(memberId, i)"
              [attr.aria-label]="getMemberLabel(memberId, i)"
            >
              {{ getMemberInitial(memberId) }}
            </span>
          </ng-template>
        </ng-container>
      </div>
      <span class="summary-members__more" *ngIf="projectDetails.memberIds.length > maxVisibleMembers">
        +{{ projectDetails.memberIds.length - maxVisibleMembers }}
      </span>
    </div>
  </section>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-left">
      <button class="btn btn-secondary back-button" type="button" (click)="goToProjectsList()">
        <span class="back-button__icon" aria-hidden="true">â†</span>
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
      </button>
      <h2>èª²é¡Œä¸€è¦§</h2>
    </div>
    <button class="btn btn-primary" *ngIf="isAdmin()" (click)="openCreateModal()">
      <i class="icon-plus"></i> æ–°è¦èª²é¡Œ
    </button>
  </div>

  <div class="filters">
    <div class="filter-group filter-group--smart">
      <button type="button" class="smart-filter-button" (click)="toggleSmartFilterPanel()">
        <span class="smart-filter-button__icon" aria-hidden="true">âš™ï¸</span>
        ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      </button>
      <a class="search-button" routerLink="/search">
        <span class="search-button__icon" aria-hidden="true">ğŸ”</span>
        æ¤œç´¢
      </a>
      <app-smart-filter-panel
        *ngIf="smartFilterVisible"
        [scope]="smartFilterScope"
        [criteria]="smartFilterCriteria"
        [tags]="smartFilterTagOptions"
        [assignees]="smartFilterAssigneeOptions"
        [statusOptions]="smartFilterStatusOptions"
        [importanceOptions]="smartFilterImportanceOptions"
        (applyCriteria)="onSmartFilterApply($event)"
        (panelClosed)="smartFilterVisible = false"
      ></app-smart-filter-panel>
    </div>
    <div class="filter-group">
      <span>ä¸¦ã³æ›¿ãˆ:</span>
      <select [(ngModel)]="sortBy" (change)="sortIssues()">
        <option value="name">åç§°</option>
        <option value="startDate">é–‹å§‹æ—¥</option>
        <option value="endDate">çµ‚äº†æ—¥</option>
        <option value="progress">é€²æ—</option>
        <option value="createdAt">ä½œæˆæ—¥</option>
      </select>
      <select [(ngModel)]="sortOrder" (change)="sortIssues()">
        <option value="asc">æ˜‡é †</option>
        <option value="desc">é™é †</option>
      </select>
    </div>
    <div class="filter-group">
      <label>
        <input type="checkbox" [(ngModel)]="showArchived" (change)="loadIssues()">
        ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã‚‚è¡¨ç¤º
      </label>
    </div>
  </div>

  <!-- èª²é¡Œä¸€è¦§ -->
  <div class="issues-grid">
    <div
      *ngFor="let issue of filteredIssues"
      class="issue-card"
      [class.archived]="issue.archived"
      [class.pinned]="isIssuePinned(issue)"
      [style.--theme-color]="getIssueThemeColorValue(issue)"
      (click)="selectIssue(issue)"
      (keydown.enter)="selectIssue(issue)"
      role="button"
      tabindex="0"
    >
      <div
        class="theme-strip"
        [style.background-color]="getIssueThemeColorValue(issue)"
      ></div>
       <div class="issue-actions">
         <button
           class="btn-icon pin-button"
           (click)="toggleIssuePin(issue, $event)"
           [title]="isIssuePinned(issue) ? 'ãƒ”ãƒ³æ­¢ã‚è§£é™¤' : 'ãƒ”ãƒ³æ­¢ã‚'"
           [class.pinned]="isIssuePinned(issue)"
           [attr.aria-pressed]="isIssuePinned(issue)"
           type="button"
         >
           <i class="icon-pin" aria-hidden="true"></i>
         </button>
         <ng-container *ngIf="isAdmin()">
           <button class="btn-icon" (click)="editIssue(issue, $event)" title="ç·¨é›†">
             <i class="icon-edit" aria-hidden="true"></i>
             <span class="action-label">ğŸ“ç·¨é›†</span>
           </button>
           <button class="btn-icon" (click)="archiveIssue(issue, $event)" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
             <i class="icon-archive" aria-hidden="true"></i>
             <span class="action-label">{{ issue.archived ? 'å¾©å…ƒ' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }}</span>
           </button>
           <button class="btn-icon" (click)="deleteIssue(issue, $event)" title="å‰Šé™¤">
             <i class="icon-delete" aria-hidden="true"></i>
             <span class="action-label">å‰Šé™¤</span>
           </button>
         </ng-container>
       </div>
        <div class="issue-title">
          <div
            class="theme-color-badge"
            [style.background-color]="getIssueThemeColorValue(issue)"
          ></div>
          <span class="pin-indicator" *ngIf="isIssuePinned(issue)" aria-hidden="true">ğŸ“Œ</span>
          <h3>{{ issue.name }}</h3>
        </div>
      
      <div class="issue-content">
        <p class="description" *ngIf="issue.description">{{ issue.description }}</p>
        
        <div class="issue-meta">
          <div class="meta-item" *ngIf="issue.startDate">
            <i class="icon-calendar"></i>
            {{ issue.startDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item" *ngIf="issue.endDate">
            <i class="icon-calendar"></i>
            {{ issue.endDate | date:'yyyy/MM/dd' }}
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>é€²æ—</span>
            <span class="progress-value">{{ issue.progress || 0 }}%</span>
          </div>
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              [style.width.%]="issue.progress || 0"
              [style.background-color]="getIssueThemeColorValue(issue)"
            ></div>
          </div>
        </div>

        <div class="issue-stats">
          <div class="stat-item">
            <span class="stat-label">ã‚¿ã‚¹ã‚¯æ•°</span>
            <span class="stat-value">{{ getTaskCount(issue.id!) }}</span>
          </div>
        </div>
        <div
          class="representative-task"
          *ngFor="let task of getAllTasks(issue.id!)"
          [style.border-left-color]="getIssueThemeColorValue(issue)"
          (click)="goToTaskDetail(issue.id!, task.id!, $event)"
          (keydown.enter)="goToTaskDetail(issue.id!, task.id!, $event)"
          role="button"
          tabindex="0"
        >
          <div class="representative-task-main">
            <span class="pin-indicator" *ngIf="isTaskPinned(task)" aria-hidden="true">ğŸ“Œ</span>
            <span class="task-title">{{ task.title }}</span>
            <span
              *ngIf="task.importance"
              class="importance-chip"
              [ngClass]="getImportanceClass(task.importance)"
            >
              {{ getImportanceLabel(task.importance) }}
            </span>
          </div>
          <!-- ã‚¿ã‚°ã¯ã‚¿ã‚¹ã‚¯ã®æƒ…å ±ã‹ã‚‰å–å¾—ã—ã€èª²é¡Œã‚«ãƒ¼ãƒ‰ã§ã‚‚è¦–èªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ -->
          <ng-container *ngIf="getTaskTags(task) as taskTags">
            <div class="representative-tags" *ngIf="taskTags.length > 0">
              <span
                *ngFor="let tag of taskTags"
                class="representative-tag"
                [style.background-color]="tag.color || '#4c6ef5'"
              >
                {{ tag.name }}
              </span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ…‹ -->
  <div *ngIf="issues.length === 0" class="empty-state">
    <i class="icon-folder"></i>
    <h3>èª²é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</h3>
    <p>æ–°ã—ã„èª²é¡Œã‚’ä½œæˆã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†</p>
    <button class="btn btn-primary" *ngIf="isAdmin()" (click)="openCreateModal()">
      èª²é¡Œã‚’ä½œæˆ
    </button>
  </div>
</div>
</div>

<!-- èª²é¡Œä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()" role="button" tabindex="-1">
  <div class="modal" (click)="$event.stopPropagation()" role="button" tabindex="-1">
    <div class="modal-header">
      <h2>{{ editingIssue ? 'èª²é¡Œç·¨é›†' : 'æ–°è¦èª²é¡Œ' }}</h2>
      <button
      class="btn-icon close-button"
      (click)="closeModal()"
      aria-label="é–‰ã˜ã‚‹"
    >
      Ã—
      </button>
    </div>
    
    <form class="modal-body" (ngSubmit)="saveIssue()">
      <div class="form-group">
        <label for="name">èª²é¡Œå *</label>
        <input
          id="name"
          type="text"
          [(ngModel)]="issueForm.name"
          name="name"
          required
          maxlength="80"
          placeholder="èª²é¡Œåã‚’å…¥åŠ›"
        >
      </div>
      <div class="form-group">
        <label for="projectId">æ‰€å±ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
        <select
          id="projectId"
          [(ngModel)]="issueForm.projectId"
          name="projectId"
          [disabled]="!editingIssue"
        >
          <option *ngFor="let project of availableProjects" [value]="project.id">
            {{ project.name }}
          </option>
        </select>
        <small class="hint" *ngIf="editingIssue">é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸èª²é¡Œã¨é…ä¸‹ã‚¿ã‚¹ã‚¯ã‚’ã¾ã¨ã‚ã¦ç§»å‹•ã—ã¾ã™ã€‚</small>
        <small class="hint" *ngIf="!editingIssue">æ–°è¦èª²é¡Œã¯ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</small>
      </div>

      <div class="form-group">
        <label for="description">èª¬æ˜</label>
        <textarea
          id="description"
          [(ngModel)]="issueForm.description" 
          name="description"
          maxlength="500"
          placeholder="èª²é¡Œã®èª¬æ˜ã‚’å…¥åŠ›"
          rows="3"
        ></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="startDate">é–‹å§‹æ—¥</label>
          <input 
            id="startDate"
            type="date" 
            [(ngModel)]="issueForm.startDate" 
            name="startDate"
          >
        </div>
        <div class="form-group">
          <label for="endDate">çµ‚äº†æ—¥</label>
          <input 
            id="endDate"
            type="date" 
            [(ngModel)]="issueForm.endDate" 
            name="endDate"
          >
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal">é”æˆç›®æ¨™</label>
        <textarea 
          id="goal"
          [(ngModel)]="issueForm.goal" 
          name="goal"
          maxlength="500"
          placeholder="èª²é¡Œã®é”æˆç›®æ¨™ã‚’å…¥åŠ›"
          rows="2"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="themeColor">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label>
        <div class="color-picker">
          <input 
            id="themeColor"
            type="color" 
            [(ngModel)]="issueForm.themeColor" 
            name="themeColor"
            class="color-input"
          >
          <span class="color-label">ã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!issueForm.name || saving">
          {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
        </button>
      </div>
    </form>
  </div>
</div>

