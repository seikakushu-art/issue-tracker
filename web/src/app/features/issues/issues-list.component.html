<div class="issues-container">
  <!-- ヘッダー -->
  <div class="header">
    <div class="header-left">
      <button class="btn btn-secondary back-button" type="button" (click)="goToDashboard()">
        <span class="back-button__icon" aria-hidden="true">←</span>
        ダッシュボードへ戻る
      </button>
      <h2>課題一覧</h2>
    </div>
    <button class="btn btn-primary" *ngIf="isAdmin()" (click)="openCreateModal()">
      <i class="icon-plus"></i> 新規課題
    </button>
  </div>

  <!-- フィルター・並び替え -->
  <section *ngIf="projectDetails" class="project-summary">
    <div class="summary-header">
      <div class="summary-title">
        <h3>{{ projectDetails.name }}</h3>
        <p class="summary-goal" *ngIf="projectDetails.goal">{{ projectDetails.goal }}</p>
      </div>
      <div class="summary-dates">
        <span *ngIf="projectDetails.startDate">開始: {{ projectDetails.startDate | date:'yyyy/MM/dd' }}</span>
        <span *ngIf="projectDetails.endDate">終了: {{ projectDetails.endDate | date:'yyyy/MM/dd' }}</span>
      </div>
    </div>

    <p class="summary-description" *ngIf="projectDetails.description">{{ projectDetails.description }}</p>

    <div class="summary-progress">
      <span class="label">進捗</span>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="projectDetails.progress || 0"></div>
      </div>
      <span class="value">{{ projectDetails.progress || 0 }}%</span>
    </div>

    <div class="summary-meta">
      <span>メンバー: {{ projectDetails.memberIds.length }}人</span>
      <span>課題数: {{ filteredIssues.length }}</span>
    </div>
    <div class="summary-members" *ngIf="projectDetails.memberIds.length > 0">
      <span class="summary-members__label">参加メンバー</span>
      <div class="summary-members__avatars" aria-label="プロジェクトメンバー">
        <ng-container *ngFor="let memberId of getVisibleMemberIds(projectDetails.memberIds); let i = index">
          <ng-container *ngIf="getMemberPhoto(memberId) as photoUrl; else issueMemberFallback">
            <span
              class="summary-avatar summary-avatar--image"
              [attr.title]="getMemberLabel(memberId, i)"
              [attr.aria-label]="getMemberLabel(memberId, i)"
            >
              <img
                class="summary-avatar__image"
                [src]="photoUrl"
                [alt]="getMemberDisplayName(memberId) + 'のアイコン'"
              >
            </span>
          </ng-container>
          <ng-template #issueMemberFallback>
            <span
              class="summary-avatar"
              [style.background]="getMemberColor(memberId)"
              [attr.title]="getMemberLabel(memberId, i)"
              [attr.aria-label]="getMemberLabel(memberId, i)"
            >
              {{ getMemberInitial(memberId) }}
            </span>
          </ng-template>
        </ng-container>
      </div>
      <span class="summary-members__more" *ngIf="projectDetails.memberIds.length > maxVisibleMembers">
        +{{ projectDetails.memberIds.length - maxVisibleMembers }}
      </span>
    </div>
  </section>

  <div class="filters">
    <div class="filter-group">
      <span>並び替え:</span>
      <select [(ngModel)]="sortBy" (change)="sortIssues()">
        <option value="name">名称</option>
        <option value="startDate">開始日</option>
        <option value="endDate">終了日</option>
        <option value="progress">進捗</option>
        <option value="createdAt">作成日</option>
      </select>
      <select [(ngModel)]="sortOrder" (change)="sortIssues()">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
      </select>
    </div>
    <div class="filter-group">
      <label>
        <input type="checkbox" [(ngModel)]="showArchived" (change)="loadIssues()">
        アーカイブ済みも表示
      </label>
    </div>
  </div>

  <!-- 課題一覧 -->
  <div class="issues-grid">
    <div
      *ngFor="let issue of filteredIssues"
      class="issue-card"
      [class.archived]="issue.archived"
      (click)="selectIssue(issue)"
      (keydown.enter)="selectIssue(issue)"
      role="button"
      tabindex="0"
    >
      <div
        class="theme-strip"
        [style.background-color]="issue.themeColor || getRandomColor(issue.id!)"
      ></div>
      <div class="issue-header">
        <div class="issue-actions" *ngIf="isAdmin()">
          <button class="btn-icon" (click)="editIssue(issue, $event)" title="編集">
            <i class="icon-edit" aria-hidden="true"></i>
            <span class="action-label">編集</span>
          </button>
          <button class="btn-icon" (click)="archiveIssue(issue, $event)" title="アーカイブ">
            <i class="icon-archive" aria-hidden="true"></i>
            <span class="action-label">{{ issue.archived ? '復元' : 'アーカイブ' }}</span>
          </button>
          <button class="btn-icon" (click)="deleteIssue(issue, $event)" title="削除">
            <i class="icon-delete" aria-hidden="true"></i>
            <span class="action-label">削除</span>
          </button>
        </div>
        <div class="issue-title">
          <div
            class="theme-color-badge"
            [style.background-color]="issue.themeColor || getRandomColor(issue.id!)"
          ></div>
          <h3>{{ issue.name }}</h3>
        </div>
      </div>
      
      <div class="issue-content">
        <p class="description" *ngIf="issue.description">{{ issue.description }}</p>
        
        <div class="issue-meta">
          <div class="meta-item" *ngIf="issue.startDate">
            <i class="icon-calendar"></i>
            {{ issue.startDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item" *ngIf="issue.endDate">
            <i class="icon-calendar"></i>
            {{ issue.endDate | date:'yyyy/MM/dd' }}
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>進捗</span>
            <span class="progress-value">{{ issue.progress || 0 }}%</span>
          </div>
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              [style.width.%]="issue.progress || 0"
              [style.background-color]="issue.themeColor || getRandomColor(issue.id!)"
            ></div>
          </div>
        </div>

        <div class="issue-stats">
          <div class="stat-item">
            <span class="stat-label">タスク数</span>
            <span class="stat-value">{{ getTaskCount(issue.id!) }}</span>
          </div>
        </div>
        <div
          class="representative-task"
          *ngIf="getRepresentativeTask(issue.id!) as representativeTask"
          [style.border-left-color]="issue.themeColor || getRandomColor(issue.id!)"
        >
          <span class="task-label">代表タスク</span>
          <div class="representative-task-main">
            <span class="task-title">{{ representativeTask.title }}</span>
            <span
              *ngIf="representativeTask?.importance as importance"
              class="importance-chip"
              [ngClass]="getImportanceClass(importance)"
            >
              {{ getImportanceLabel(importance) }}
            </span>
          </div>
          <!-- タグは代表タスクの情報から取得し、課題カードでも視認できるようにする -->
          <ng-container *ngIf="getRepresentativeTags(issue.id!) as representativeTags">
            <div class="representative-tags" *ngIf="representativeTags.length > 0">
              <span
                *ngFor="let tag of representativeTags"
                class="representative-tag"
                [style.background-color]="tag.color || '#4c6ef5'"
              >
                {{ tag.name }}
              </span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- 空状態 -->
  <div *ngIf="issues.length === 0" class="empty-state">
    <i class="icon-folder"></i>
    <h3>課題がありません</h3>
    <p>新しい課題を作成して始めましょう</p>
    <button class="btn btn-primary" *ngIf="isAdmin()" (click)="openCreateModal()">
      課題を作成
    </button>
  </div>
</div>

<!-- 課題作成・編集モーダル -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()" role="button" tabindex="-1">
  <div class="modal" (click)="$event.stopPropagation()" role="button" tabindex="-1">
    <div class="modal-header">
      <h2>{{ editingIssue ? '課題編集' : '新規課題' }}</h2>
      <button
      class="btn-icon close-button"
      (click)="closeModal()"
      aria-label="閉じる"
    >
      ×
      </button>
    </div>
    
    <form class="modal-body" (ngSubmit)="saveIssue()">
      <div class="form-group">
        <label for="name">課題名 *</label>
        <input
          id="name"
          type="text"
          [(ngModel)]="issueForm.name"
          name="name"
          required
          placeholder="課題名を入力"
        >
      </div>
      <div class="form-group">
        <label for="projectId">所属プロジェクト</label>
        <select
          id="projectId"
          [(ngModel)]="issueForm.projectId"
          name="projectId"
          [disabled]="!editingIssue"
        >
          <option *ngFor="let project of availableProjects" [value]="project.id">
            {{ project.name }}
          </option>
        </select>
        <small class="hint" *ngIf="editingIssue">選択したプロジェクトへ課題と配下タスクをまとめて移動します。</small>
        <small class="hint" *ngIf="!editingIssue">新規課題は現在表示中のプロジェクトに登録されます。</small>
      </div>

      <div class="form-group">
        <label for="description">説明</label>
        <textarea
          id="description"
          [(ngModel)]="issueForm.description" 
          name="description"
          placeholder="課題の説明を入力"
          rows="3"
        ></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="startDate">開始日</label>
          <input 
            id="startDate"
            type="date" 
            [(ngModel)]="issueForm.startDate" 
            name="startDate"
          >
        </div>
        <div class="form-group">
          <label for="endDate">終了日</label>
          <input 
            id="endDate"
            type="date" 
            [(ngModel)]="issueForm.endDate" 
            name="endDate"
          >
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal">達成目標</label>
        <textarea 
          id="goal"
          [(ngModel)]="issueForm.goal" 
          name="goal"
          placeholder="課題の達成目標を入力"
          rows="2"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="themeColor">テーマカラー</label>
        <div class="color-picker">
          <input 
            id="themeColor"
            type="color" 
            [(ngModel)]="issueForm.themeColor" 
            name="themeColor"
            class="color-input"
          >
          <span class="color-label">カラーを選択</span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          キャンセル
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!issueForm.name || saving">
          {{ saving ? '保存中...' : '保存' }}
        </button>
      </div>
    </form>
  </div>
</div>

