<div class="projects-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-left">
      <button class="btn btn-secondary back-button" type="button" (click)="goToDashboard()">
        <span class="back-button__icon" aria-hidden="true">â†</span>
        ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹
      </button>
      <h1>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h1>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i> æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
    </button>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ä¸¦ã³æ›¿ãˆ -->
  <div class="filters">
    <div class="filter-group filter-group--smart">
      <button type="button" class="smart-filter-button" (click)="toggleSmartFilterPanel()">
        <span class="smart-filter-button__icon" aria-hidden="true">âš™ï¸</span>
        ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      </button>
      <a class="search-button" routerLink="/search">
        <span class="search-button__icon" aria-hidden="true">ğŸ”</span>
        æ¤œç´¢
      </a>
      <app-smart-filter-panel
        *ngIf="smartFilterVisible"
        [scope]="smartFilterScope"
        [criteria]="smartFilterCriteria"
        [tags]="smartFilterTagOptions"
        [assignees]="smartFilterAssigneeOptions"
        [statusOptions]="smartFilterStatusOptions"
        [importanceOptions]="smartFilterImportanceOptions"
        (applyCriteria)="onSmartFilterApply($event)"
        (panelClosed)="smartFilterVisible = false"
      ></app-smart-filter-panel>
    </div>
    <div class="filter-group">
      <span>ä¸¦ã³æ›¿ãˆ:</span>
      <select [(ngModel)]="sortBy" (change)="sortProjects()">
        <option value="name">åç§°</option>
        <option value="startDate">é–‹å§‹æ—¥</option>
        <option value="endDate">çµ‚äº†æ—¥</option>
        <option value="progress">é€²æ—</option>
        <option value="createdAt">ä½œæˆæ—¥</option>
        <option value="period">æœŸé–“</option>
        <option value="issueCount">èª²é¡Œæ•°</option>
        <option value="memberCount">ãƒ¡ãƒ³ãƒãƒ¼æ•°</option>
      </select>
      <select [(ngModel)]="sortOrder" (change)="sortProjects()">
        <option value="asc">æ˜‡é †</option>
        <option value="desc">é™é †</option>
      </select>
    </div>
    <div class="filter-group">
      <label>
        <input type="checkbox" [(ngModel)]="showArchived" (change)="loadProjects()">
        ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ã‚‚è¡¨ç¤º
      </label>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
  <div class="projects-grid">
    <div 
      *ngFor="let project of filteredProjects" 
      class="project-card"
      [class.archived]="project.archived"
      role="button"
      tabindex="0"
      (click)="selectProject(project)"
      (keydown.enter)="selectProject(project)"
    >
      <div class="project-header">
        <div class="project-actions" *ngIf="canManage(project)">
          <button class="btn-action" (click)="editProject(project, $event)" title="ç·¨é›†">
            <i class="icon-edit" aria-hidden="true"></i>
            <span class="action-label">ç·¨é›†</span>
          </button>
          <button class="btn-action" (click)="archiveProject(project, $event)" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–">
            <i class="icon-archive" aria-hidden="true"></i>
            <span class="action-label">{{ project.archived ? 'å¾©å…ƒ' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–' }}</span>
          </button>
          <button class="btn-action" (click)="saveAsTemplate(project, $event)" title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜">
            <i class="icon-template" aria-hidden="true"></i>
            <span class="action-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
          </button>
          <button class="btn-action" (click)="openInviteModal(project, $event)" title="æ‹›å¾…ãƒªãƒ³ã‚¯">
            <i class="icon-link" aria-hidden="true"></i>
            <span class="action-label">æ‹›å¾…</span>
          </button>
          <button class="btn-action" (click)="deleteProject(project, $event)" title="å‰Šé™¤">
            <i class="icon-delete" aria-hidden="true"></i>
            <span class="action-label">å‰Šé™¤</span>
          </button>
        </div>
        <h3 class="project-title">{{ project.name }}</h3>
      </div>
      
      <div class="project-content">
        <p class="description" *ngIf="project.description">{{ project.description }}</p>
        <div class="project-members" *ngIf="project.memberIds.length > 0">
          <div class="avatar-group" aria-label="å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼">
            <ng-container *ngFor="let memberId of getVisibleMemberIds(project.memberIds); let i = index">
              <ng-container *ngIf="getMemberPhoto(memberId) as photoUrl; else projectMemberFallback">
                <span
                  class="avatar avatar--image"
                  [attr.title]="getMemberLabel(memberId, i)"
                  [attr.aria-label]="getMemberLabel(memberId, i)"
                >
                  <img
                    class="avatar__image"
                    [src]="photoUrl"
                    [alt]="getMemberDisplayName(memberId) + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'"
                  >
                </span>
              </ng-container>
              <ng-template #projectMemberFallback>
                <span
                  class="avatar"
                  [style.background]="getMemberColor(memberId)"
                  [attr.title]="getMemberLabel(memberId, i)"
                  [attr.aria-label]="getMemberLabel(memberId, i)"
                >
                  {{ getMemberInitial(memberId) }}
                </span>
              </ng-template>
            </ng-container>
          </div>
          <span class="avatar-count" *ngIf="project.memberIds.length > maxVisibleMembers">
            +{{ project.memberIds.length - maxVisibleMembers }}
          </span>
        </div>
        
        <div class="project-meta">
          <div class="meta-item" *ngIf="project.startDate">
            <i class="icon-calendar"></i>
            {{ project.startDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item" *ngIf="project.endDate">
            <i class="icon-calendar"></i>
            {{ project.endDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item">
            <i class="icon-users"></i>
            {{ project.memberIds.length }}äºº
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>é€²æ—</span>
            <span class="progress-value">{{ project.progress || 0 }}%</span>
          </div>
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              [style.width.%]="project.progress || 0"
            ></div>
          </div>
        </div>

        <div class="project-stats">
          <div class="stat-item">
            <span class="stat-label">èª²é¡Œæ•°</span>
            <span class="stat-value">{{ getIssueCount(project.id!) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ã‚¿ã‚¹ã‚¯æ•°</span>
            <span class="stat-value">{{ getTaskCount(project.id!) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç©ºçŠ¶æ…‹ -->
  <div *ngIf="projects.length === 0" class="empty-state">
    <i class="icon-folder"></i>
    <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h3>
    <p>æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦å§‹ã‚ã¾ã—ã‚‡ã†</p>
    <button class="btn btn-primary" (click)="openCreateModal()">
      ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    </button>
  </div>
</div>

<!-- æ‹›å¾…ãƒªãƒ³ã‚¯ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div *ngIf="showInviteModal" class="modal-overlay" (click)="closeInviteModal()" (keydown.enter)="closeInviteModal()" (keydown.escape)="closeInviteModal()" role="button" tabindex="-1">
  <div class="modal invite-modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="dialog" tabindex="-1">
    <div class="modal-header">
      <h2>æ‹›å¾…ãƒªãƒ³ã‚¯ã®ç®¡ç†</h2>
      <button
        class="btn-icon close-button"
        (click)="closeInviteModal()"
        aria-label="é–‰ã˜ã‚‹"
      >
        Ã—
      </button>
    </div>

    <div class="modal-body invite-body">
      <p class="invite-description">
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ{{ inviteProject?.name }}ã€ã«ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…ã—ã¾ã™ã€‚
      </p>

      <form class="invite-form" (ngSubmit)="createInvite()">
        <div class="form-row">
          <label for="inviteRole">ä»˜ä¸ã™ã‚‹æ¨©é™</label>
          <select id="inviteRole" [(ngModel)]="inviteForm.role" name="inviteRole">
            <option value="admin">ç®¡ç†è€…</option>
            <option value="member">ãƒ¡ãƒ³ãƒãƒ¼</option>
            <option value="guest">ã‚²ã‚¹ãƒˆ</option>
          </select>
        </div>
        <div class="form-row">
          <label for="inviteExpiry">æœ‰åŠ¹æœŸé™</label>
          <select id="inviteExpiry" [(ngModel)]="inviteForm.expiresInHours" name="expiresIn">
            <option [value]="24">24æ™‚é–“</option>
            <option [value]="72">3æ—¥é–“</option>
            <option [value]="168">7æ—¥é–“</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" [disabled]="inviteLoading">
          {{ inviteLoading ? 'ç™ºè¡Œä¸­...' : 'æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œ' }}
        </button>
      </form>

      <div class="generated-link" *ngIf="generatedUrl">
        <input type="text" [value]="generatedUrl" readonly>
        <button type="button" class="btn btn-secondary" (click)="copyInvite(generatedUrl)">
          ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>

      <p *ngIf="inviteMessage" class="success-message">{{ inviteMessage }}</p>
      <p *ngIf="inviteError" class="error-message">{{ inviteError }}</p>

      <section class="member-management" *ngIf="inviteProject">
        <div class="member-management__header">
          <h3>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</h3>
          <span class="member-management__count">{{ inviteProject.memberIds.length }}äºº</span>
        </div>
        <p class="info-text" *ngIf="inviteProject.memberIds.length === 0">
          ã¾ã ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¦ã„ã¾ã›ã‚“ã€‚
        </p>
        <ul class="member-list" *ngIf="inviteProject.memberIds.length > 0">
          <li class="member-item" *ngFor="let memberId of inviteProject.memberIds">
            <div class="member-item__info">
              <span class="member-item__name">{{ getMemberDisplayName(memberId) }}</span>
              <span class="member-item__role">æ¨©é™: {{ getMemberRoleLabel(inviteProject, memberId) }}</span>
            </div>
            <button
              type="button"
              class="btn btn-secondary btn-small"
              *ngIf="canRemoveMember(inviteProject, memberId)"
              (click)="removeMember(memberId)"
              [disabled]="removingMemberId === memberId"
            >
              {{ removingMemberId === memberId ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤' }}
            </button>
          </li>
        </ul>
        <p *ngIf="memberRemovalMessage" class="success-message">{{ memberRemovalMessage }}</p>
        <p *ngIf="memberRemovalError" class="error-message">{{ memberRemovalError }}</p>
      </section>

      <div class="invite-list" *ngIf="inviteLinks.length > 0">
        <table>
          <thead>
            <tr>
              <th>æ¨©é™</th>
              <th>æœŸé™</th>
              <th>çŠ¶æ…‹</th>
              <th>URL</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invite of inviteLinks">
              <td>{{ translateRole(invite.role) }}</td>
              <td>{{ invite.expiresAt | date:'yyyy/MM/dd HH:mm' }}</td>
              <td>{{ translateInviteStatus(invite.status) }}</td>
              <td>
                <div class="link-cell">
                  <input type="text" [value]="buildInviteUrl(invite)" readonly>
                  <button type="button" class="btn btn-secondary btn-small" (click)="copyInvite(buildInviteUrl(invite))">
                    ã‚³ãƒ”ãƒ¼
                  </button>
                </div>
              </td>
              <td>
                <button
                  type="button"
                  class="btn btn-secondary btn-small"
                  (click)="revokeInvite(invite)"
                  [disabled]="invite.status !== 'active'"
                >
                  ç„¡åŠ¹åŒ–
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p *ngIf="!inviteLoading && inviteLinks.length === 0" class="info-text">
        ç™ºè¡Œæ¸ˆã¿ã®æ‹›å¾…ãƒªãƒ³ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
      </p>
    </div>
  </div>
</div>

<!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()" (keydown.enter)="closeModal()" (keydown.escape)="closeModal()" role="button" tabindex="-1">
  <div class="modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="button" tabindex="-1">
    <div class="modal-header">
      <h2>{{ editingProject ? 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†' : 'æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ' }}</h2>
      <button
      class="btn-icon close-button"
      (click)="closeModal()"
      (keydown.enter)="closeModal()"
      aria-label="é–‰ã˜ã‚‹"
    >
      Ã—
      </button>
    </div>
    
    <form class="modal-body" (ngSubmit)="saveProject()">
      <div *ngIf="!editingProject" class="template-section">
        <label for="templateSelect">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆ</label>
        <div class="template-select-row">
          <select
            id="templateSelect"
            name="templateSelect"
            [(ngModel)]="selectedTemplateId"
            (ngModelChange)="applyTemplate($event)"
          >
            <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
          </select>
          <button
          type="button"
          class="btn btn-secondary btn-small"
          *ngIf="selectedTemplateId"
          (click)="deleteSelectedTemplate()"
          [disabled]="templateDeleting"
        >
          {{ templateDeleting ? 'å‰Šé™¤ä¸­...' : 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤' }}
        </button>
          <span class="template-loading" *ngIf="templatesLoading">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <p class="template-error" *ngIf="templateLoadError">{{ templateLoadError }}</p>
        <p class="template-info" *ngIf="!templatesLoading && templates.length === 0 && !templateLoadError">
          ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ã®ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‹ã‚‰ä¿å­˜ã§ãã¾ã™ã€‚
        </p>
        <p class="template-notice" *ngIf="templateNotice">{{ templateNotice }}</p>
      </div>
      <div class="form-group">
        <label for="name">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå *</label>
        <input
          id="name"
          type="text"
          [(ngModel)]="projectForm.name" 
          name="name"
          required
          placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›"
        >
      </div>
      
      <div class="form-group">
        <label for="description">èª¬æ˜</label>
        <textarea 
          id="description"
          [(ngModel)]="projectForm.description" 
          name="description"
          placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’å…¥åŠ›"
          rows="3"
        ></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="startDate">é–‹å§‹æ—¥</label>
          <input 
            id="startDate"
            type="date" 
            [(ngModel)]="projectForm.startDate" 
            name="startDate"
          >
        </div>
        <div class="form-group">
          <label for="endDate">çµ‚äº†æ—¥</label>
    <input
            id="endDate"
            type="date" 
            [(ngModel)]="projectForm.endDate" 
            name="endDate"
          >
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal">é”æˆç›®æ¨™</label>
          <textarea 
            id="goal"
            [(ngModel)]="projectForm.goal" 
            name="goal"
            placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é”æˆç›®æ¨™ã‚’å…¥åŠ›"
            rows="2"
          ></textarea>
      </div>
      <div class="form-group" *ngIf="editingProject">
        <label for="memberSearch">æ‹…å½“è€…ã®ç·¨é›†</label>
        <div class="member-editor">
          <div class="member-editor__search">
            <input
              id="memberSearch"
              type="search"
              name="memberSearch"
              [(ngModel)]="memberSearchTerm"
              placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢"
            >
          </div>
          <div class="member-editor__list">
            <p class="info-text" *ngIf="editingProject.memberIds.length === 0">
              å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚
            </p>
            <p
              class="info-text"
              *ngIf="editingProject.memberIds.length > 0 && filteredEditingMemberIds.length === 0"
            >
              æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
            </p>
            <ul class="member-editor__items" *ngIf="filteredEditingMemberIds.length > 0">
              <li class="member-editor__item" *ngFor="let memberId of filteredEditingMemberIds">
                <div class="member-editor__member">
                  <ng-container *ngIf="getMemberPhoto(memberId) as photoUrl; else memberEditorFallback">
                    <span class="member-editor__avatar member-editor__avatar--image">
                      <img [src]="photoUrl" [alt]="getMemberDisplayName(memberId) + 'ã®ã‚¢ã‚¤ã‚³ãƒ³'">
                    </span>
                  </ng-container>
                  <ng-template #memberEditorFallback>
                    <span class="member-editor__avatar" [style.background]="getMemberColor(memberId)">
                      {{ getMemberInitial(memberId) }}
                    </span>
                  </ng-template>
                  <div class="member-editor__details">
                    <span class="member-editor__name">{{ getMemberDisplayName(memberId) }}</span>
                    <span class="member-editor__role">æ¨©é™: {{ getMemberRoleLabel(editingProject, memberId) }}</span>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-secondary btn-small"
                  *ngIf="canRemoveMember(editingProject, memberId)"
                  (click)="removeMemberFromEditing(memberId)"
                  [disabled]="removingMemberId === memberId"
                >
                  {{ removingMemberId === memberId ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤' }}
                </button>
              </li>
            </ul>
            <p *ngIf="memberRemovalMessage" class="success-message">{{ memberRemovalMessage }}</p>
            <p *ngIf="memberRemovalError" class="error-message">{{ memberRemovalError }}</p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!projectForm.name || saving">
          {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}
        </button>
      </div>
    </form>
  </div>
</div>

