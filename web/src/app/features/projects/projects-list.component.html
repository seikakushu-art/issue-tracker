<div class="projects-container">
  <!-- ヘッダー -->
  <div class="header">
    <div class="header-left">
      <button class="btn btn-secondary back-button" type="button" (click)="goToDashboard()">
        <span class="back-button__icon" aria-hidden="true">←</span>
        ダッシュボードへ戻る
      </button>
      <h1>プロジェクト一覧</h1>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i> 新規プロジェクト
    </button>
  </div>

  <!-- フィルター・並び替え -->
  <div class="filters">
    <div class="filter-group filter-group--smart">
      <button type="button" class="smart-filter-button" (click)="toggleSmartFilterPanel()">
        <span class="smart-filter-button__icon" aria-hidden="true">⚙️</span>
        スマートフィルター
      </button>
      <a class="search-button" routerLink="/search">
        <span class="search-button__icon" aria-hidden="true">🔍</span>
        検索
      </a>
      <app-smart-filter-panel
        *ngIf="smartFilterVisible"
        [scope]="smartFilterScope"
        [criteria]="smartFilterCriteria"
        [tags]="smartFilterTagOptions"
        [assignees]="smartFilterAssigneeOptions"
        [statusOptions]="smartFilterStatusOptions"
        [importanceOptions]="smartFilterImportanceOptions"
        (applyCriteria)="onSmartFilterApply($event)"
        (panelClosed)="smartFilterVisible = false"
      ></app-smart-filter-panel>
    </div>
    <div class="filter-group">
      <span>並び替え:</span>
      <select [(ngModel)]="sortBy" (change)="sortProjects()">
        <option value="name">名称</option>
        <option value="startDate">開始日</option>
        <option value="endDate">終了日</option>
        <option value="progress">進捗</option>
        <option value="createdAt">作成日</option>
        <option value="period">期間</option>
        <option value="issueCount">課題数</option>
        <option value="memberCount">メンバー数</option>
      </select>
      <select [(ngModel)]="sortOrder" (change)="sortProjects()">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
      </select>
    </div>
    <div class="filter-group">
      <label>
        <input type="checkbox" [(ngModel)]="showArchived" (change)="loadProjects()">
        アーカイブ済みも表示
      </label>
    </div>
  </div>

  <!-- プロジェクト一覧 -->
  <div class="projects-grid">
    <div 
      *ngFor="let project of filteredProjects" 
      class="project-card"
      [class.archived]="project.archived"
      role="button"
      tabindex="0"
      (click)="selectProject(project)"
      (keydown.enter)="selectProject(project)"
    >
      <div class="project-header">
        <div class="project-actions" *ngIf="canManage(project)">
          <button class="btn-action" (click)="editProject(project, $event)" title="編集">
            <i class="icon-edit" aria-hidden="true"></i>
            <span class="action-label">編集</span>
          </button>
          <button class="btn-action" (click)="archiveProject(project, $event)" title="アーカイブ">
            <i class="icon-archive" aria-hidden="true"></i>
            <span class="action-label">{{ project.archived ? '復元' : 'アーカイブ' }}</span>
          </button>
          <button class="btn-action" (click)="saveAsTemplate(project, $event)" title="テンプレートとして保存">
            <i class="icon-template" aria-hidden="true"></i>
            <span class="action-label">テンプレート</span>
          </button>
          <button class="btn-action" (click)="openInviteModal(project, $event)" title="招待リンク">
            <i class="icon-link" aria-hidden="true"></i>
            <span class="action-label">招待</span>
          </button>
          <button class="btn-action" (click)="deleteProject(project, $event)" title="削除">
            <i class="icon-delete" aria-hidden="true"></i>
            <span class="action-label">削除</span>
          </button>
        </div>
        <h3 class="project-title">{{ project.name }}</h3>
      </div>
      
      <div class="project-content">
        <p class="description" *ngIf="project.description">{{ project.description }}</p>
        <div class="project-members" *ngIf="project.memberIds.length > 0">
          <div class="avatar-group" aria-label="参加メンバー">
            <ng-container *ngFor="let memberId of getVisibleMemberIds(project.memberIds); let i = index">
              <ng-container *ngIf="getMemberPhoto(memberId) as photoUrl; else projectMemberFallback">
                <span
                  class="avatar avatar--image"
                  [attr.title]="getMemberLabel(memberId, i)"
                  [attr.aria-label]="getMemberLabel(memberId, i)"
                >
                  <img
                    class="avatar__image"
                    [src]="photoUrl"
                    [alt]="getMemberDisplayName(memberId) + 'のアイコン'"
                  >
                </span>
              </ng-container>
              <ng-template #projectMemberFallback>
                <span
                  class="avatar"
                  [style.background]="getMemberColor(memberId)"
                  [attr.title]="getMemberLabel(memberId, i)"
                  [attr.aria-label]="getMemberLabel(memberId, i)"
                >
                  {{ getMemberInitial(memberId) }}
                </span>
              </ng-template>
            </ng-container>
          </div>
          <span class="avatar-count" *ngIf="project.memberIds.length > maxVisibleMembers">
            +{{ project.memberIds.length - maxVisibleMembers }}
          </span>
        </div>
        
        <div class="project-meta">
          <div class="meta-item" *ngIf="project.startDate">
            <i class="icon-calendar"></i>
            {{ project.startDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item" *ngIf="project.endDate">
            <i class="icon-calendar"></i>
            {{ project.endDate | date:'yyyy/MM/dd' }}
          </div>
          <div class="meta-item">
            <i class="icon-users"></i>
            {{ project.memberIds.length }}人
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span>進捗</span>
            <span class="progress-value">{{ project.progress || 0 }}%</span>
          </div>
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              [style.width.%]="project.progress || 0"
            ></div>
          </div>
        </div>

        <div class="project-stats">
          <div class="stat-item">
            <span class="stat-label">課題数</span>
            <span class="stat-value">{{ getIssueCount(project.id!) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">タスク数</span>
            <span class="stat-value">{{ getTaskCount(project.id!) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 空状態 -->
  <div *ngIf="projects.length === 0" class="empty-state">
    <i class="icon-folder"></i>
    <h3>プロジェクトがありません</h3>
    <p>新しいプロジェクトを作成して始めましょう</p>
    <button class="btn btn-primary" (click)="openCreateModal()">
      プロジェクトを作成
    </button>
  </div>
</div>

<!-- 招待リンク管理モーダル -->
<div *ngIf="showInviteModal" class="modal-overlay" (click)="closeInviteModal()" (keydown.enter)="closeInviteModal()" (keydown.escape)="closeInviteModal()" role="button" tabindex="-1">
  <div class="modal invite-modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="dialog" tabindex="-1">
    <div class="modal-header">
      <h2>招待リンクの管理</h2>
      <button
        class="btn-icon close-button"
        (click)="closeInviteModal()"
        aria-label="閉じる"
      >
        ×
      </button>
    </div>

    <div class="modal-body invite-body">
      <p class="invite-description">
        プロジェクト「{{ inviteProject?.name }}」にメンバーを招待します。
      </p>

      <form class="invite-form" (ngSubmit)="createInvite()">
        <div class="form-row">
          <label for="inviteRole">付与する権限</label>
          <select id="inviteRole" [(ngModel)]="inviteForm.role" name="inviteRole">
            <option value="admin">管理者</option>
            <option value="member">メンバー</option>
            <option value="guest">ゲスト</option>
          </select>
        </div>
        <div class="form-row">
          <label for="inviteExpiry">有効期限</label>
          <select id="inviteExpiry" [(ngModel)]="inviteForm.expiresInHours" name="expiresIn">
            <option [value]="24">24時間</option>
            <option [value]="72">3日間</option>
            <option [value]="168">7日間</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" [disabled]="inviteLoading">
          {{ inviteLoading ? '発行中...' : '招待リンクを発行' }}
        </button>
      </form>

      <div class="generated-link" *ngIf="generatedUrl">
        <input type="text" [value]="generatedUrl" readonly>
        <button type="button" class="btn btn-secondary" (click)="copyInvite(generatedUrl)">
          リンクをコピー
        </button>
      </div>

      <p *ngIf="inviteMessage" class="success-message">{{ inviteMessage }}</p>
      <p *ngIf="inviteError" class="error-message">{{ inviteError }}</p>

      <div class="invite-list" *ngIf="inviteLinks.length > 0">
        <table>
          <thead>
            <tr>
              <th>権限</th>
              <th>期限</th>
              <th>状態</th>
              <th>URL</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invite of inviteLinks">
              <td>{{ translateRole(invite.role) }}</td>
              <td>{{ invite.expiresAt | date:'yyyy/MM/dd HH:mm' }}</td>
              <td>{{ translateInviteStatus(invite.status) }}</td>
              <td>
                <div class="link-cell">
                  <input type="text" [value]="buildInviteUrl(invite)" readonly>
                  <button type="button" class="btn btn-secondary btn-small" (click)="copyInvite(buildInviteUrl(invite))">
                    コピー
                  </button>
                </div>
              </td>
              <td>
                <button
                  type="button"
                  class="btn btn-secondary btn-small"
                  (click)="revokeInvite(invite)"
                  [disabled]="invite.status !== 'active'"
                >
                  無効化
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p *ngIf="!inviteLoading && inviteLinks.length === 0" class="info-text">
        発行済みの招待リンクはありません。
      </p>
    </div>
  </div>
</div>

<!-- プロジェクト作成・編集モーダル -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()" (keydown.enter)="closeModal()" (keydown.escape)="closeModal()" role="button" tabindex="-1">
  <div class="modal" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="button" tabindex="-1">
    <div class="modal-header">
      <h2>{{ editingProject ? 'プロジェクト編集' : '新規プロジェクト' }}</h2>
      <button
      class="btn-icon close-button"
      (click)="closeModal()"
      (keydown.enter)="closeModal()"
      aria-label="閉じる"
    >
      ×
      </button>
    </div>
    
    <form class="modal-body" (ngSubmit)="saveProject()">
      <div *ngIf="!editingProject" class="template-section">
        <label for="templateSelect">テンプレートから作成</label>
        <div class="template-select-row">
          <select
            id="templateSelect"
            name="templateSelect"
            [(ngModel)]="selectedTemplateId"
            (ngModelChange)="applyTemplate($event)"
          >
            <option value="">テンプレートを選択してください</option>
            <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
          </select>
          <span class="template-loading" *ngIf="templatesLoading">読み込み中...</span>
        </div>
        <p class="template-error" *ngIf="templateLoadError">{{ templateLoadError }}</p>
        <p class="template-info" *ngIf="!templatesLoading && templates.length === 0 && !templateLoadError">
          保存済みテンプレートはまだありません。プロジェクトカードの「テンプレート」から保存できます。
        </p>
        <p class="template-notice" *ngIf="templateNotice">{{ templateNotice }}</p>
      </div>
      <div class="form-group">
        <label for="name">プロジェクト名 *</label>
        <input
          id="name"
          type="text"
          [(ngModel)]="projectForm.name" 
          name="name"
          required
          placeholder="プロジェクト名を入力"
        >
      </div>
      
      <div class="form-group">
        <label for="description">説明</label>
        <textarea 
          id="description"
          [(ngModel)]="projectForm.description" 
          name="description"
          placeholder="プロジェクトの説明を入力"
          rows="3"
        ></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="startDate">開始日</label>
          <input 
            id="startDate"
            type="date" 
            [(ngModel)]="projectForm.startDate" 
            name="startDate"
          >
        </div>
        <div class="form-group">
          <label for="endDate">終了日</label>
    <input
            id="endDate"
            type="date" 
            [(ngModel)]="projectForm.endDate" 
            name="endDate"
          >
        </div>
      </div>
      
      <div class="form-group">
        <label for="goal">達成目標</label>
          <textarea 
            id="goal"
            [(ngModel)]="projectForm.goal" 
            name="goal"
            placeholder="プロジェクトの達成目標を入力"
            rows="2"
          ></textarea>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          キャンセル
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!projectForm.name || saving">
          {{ saving ? '保存中...' : '保存' }}
        </button>
      </div>
    </form>
  </div>
</div>

