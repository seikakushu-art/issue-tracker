rules_version = '2';//「プロジェクトのメンバーのみ読み書き」 を守る最小ルール
service cloud.firestore {
match /databases/{database}/documents {
function signedIn() { return request.auth != null; }
function isMember(projectId) {
return signedIn() && (request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberIds);
}
function role(projectId) {
return get(/databases/$(database)/documents/projects/$(projectId)).data.roles[request.auth.uid];
}

function canPostToProject(projectId) {
return isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
}

function canViewBulletin(projectIds) {
return projectIds.size() > 0 && (
  (projectIds.size() > 0 && isMember(projectIds[0])) ||
  (projectIds.size() > 1 && isMember(projectIds[1])) ||
  (projectIds.size() > 2 && isMember(projectIds[2])) ||
  (projectIds.size() > 3 && isMember(projectIds[3])) ||
  (projectIds.size() > 4 && isMember(projectIds[4]))
);
}

function canPostBulletin(projectIds) {
return projectIds.size() > 0 && projectIds.size() <= 5 &&
  canPostToProject(projectIds[0]) &&
  (projectIds.size() < 2 || canPostToProject(projectIds[1])) &&
  (projectIds.size() < 3 || canPostToProject(projectIds[2])) &&
  (projectIds.size() < 4 || canPostToProject(projectIds[3])) &&
  (projectIds.size() < 5 || canPostToProject(projectIds[4]));
}

match /users/{uid} {
allow read, write: if signedIn() && uid == request.auth.uid;
}

match /bulletinPosts/{postId} {
allow read: if signedIn() && canViewBulletin(resource.data.projectIds);
allow create: if signedIn() && canPostBulletin(request.resource.data.projectIds);
allow update, delete: if signedIn() &&
  request.auth.uid == resource.data.authorId &&
  canPostBulletin(resource.data.projectIds) &&
  canPostBulletin(request.resource.data.projectIds);
}

match /projects/{projectId} {
allow create: if signedIn();
allow read: if isMember(projectId);
allow update, delete: if isMember(projectId) && role(projectId) == 'admin';

// 課題のルール
match /issues/{issueId} {
allow read: if isMember(projectId);
// 課題の作成・更新は管理者のみ（サービス層の実装と一致）
allow create, update: if isMember(projectId) && role(projectId) == 'admin';
allow delete: if isMember(projectId) && role(projectId) == 'admin';

// タスクのルール（正しいパス構造: projects/{projectId}/issues/{issueId}/tasks/{taskId}）
match /tasks/{taskId} {
allow read: if isMember(projectId);
// タスクの作成はadmin/member（サービス層の実装と一致）
allow create: if isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
// タスクの更新はadmin全員、またはmemberは自分の作成または担当者のタスクのみ（サービス層の実装と一致）
allow update: if isMember(projectId) && (
  role(projectId) == 'admin' ||
  (role(projectId) == 'member' && (
    resource.data.createdBy == request.auth.uid ||
    (resource.data.assigneeIds != null && request.auth.uid in resource.data.assigneeIds)
  ))
);
// タスクの削除はadmin全員、またはmemberは自分の作成したタスクのみ（サービス層の実装と一致）
allow delete: if isMember(projectId) && (
  role(projectId) == 'admin' ||
  (role(projectId) == 'member' && resource.data.createdBy == request.auth.uid)
);

// コメントのルール
match /comments/{commentId} {
allow read: if isMember(projectId);
// コメントの作成はadmin/member（サービス層の実装と一致）
allow create: if isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
// コメントの削除は作成者本人または管理者（サービス層の実装と一致）
allow delete: if isMember(projectId) && (resource.data.createdBy == request.auth.uid || role(projectId) == 'admin');
}

// 添付ファイルのルール
match /attachments/{attachmentId} {
allow read: if isMember(projectId);
// 添付ファイルの作成はadmin/member（詳細な権限チェックはサービス層で実施）
// サービス層でタスク編集権限をチェックしているため、ここではadmin/memberに許可
allow create: if isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
// 添付ファイルの削除はadmin全員、またはmemberは自分のアップロードしたファイルのみ（サービス層の実装と一致）
allow delete: if isMember(projectId) && (
  role(projectId) == 'admin' ||
  (role(projectId) == 'member' && resource.data.uploadedBy == request.auth.uid)
);
}

// タグのルール
match /tags/{tagId} {
allow read: if isMember(projectId);
// タグの作成はadmin/member（サービス層の実装と一致）
allow create: if isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
// タグの更新はadmin全員、またはmemberは自分が作成したタグのみ（サービス層の実装と一致）
allow update: if isMember(projectId) && (
  role(projectId) == 'admin' ||
  (role(projectId) == 'member' && resource.data.createdBy == request.auth.uid)
);
// タグの削除はadmin全員、またはmemberは自分が作成したタグのみ（サービス層の実装と一致）
allow delete: if isMember(projectId) && (
  role(projectId) == 'admin' ||
  (role(projectId) == 'member' && resource.data.createdBy == request.auth.uid)
);
}
}
}
}


match /invites/{inviteId} {
allow read: if isMember(projectId); // 受け取り側で照合する想定
allow create, update, delete: if isMember(projectId) && role(projectId) == 'admin';
}
}


// フラットなコレクションを使う MVP 用（後で削除可）
// 注意: このルールは実際には使用されていない（タスクは projects/{projectId}/issues/{issueId}/tasks/{taskId} に保存される）
match /tasks/{taskId} {
allow read, write: if signedIn();
}
}
}
