rules_version = '2';//「プロジェクトのメンバーのみ読み書き」 を守る最小ルール
service cloud.firestore {
match /databases/{database}/documents {
function signedIn() { return request.auth != null; }
function isMember(projectId) {
return signedIn() && (request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.memberIds);
}
function role(projectId) {
return get(/databases/$(database)/documents/projects/$(projectId)).data.roles[request.auth.uid];
}

function canPostToProject(projectId) {
return isMember(projectId) && (role(projectId) == 'admin' || role(projectId) == 'member');
}

function canViewBulletin(projectIds) {
return projectIds.size() > 0 && (
  (projectIds.size() > 0 && isMember(projectIds[0])) ||
  (projectIds.size() > 1 && isMember(projectIds[1])) ||
  (projectIds.size() > 2 && isMember(projectIds[2])) ||
  (projectIds.size() > 3 && isMember(projectIds[3])) ||
  (projectIds.size() > 4 && isMember(projectIds[4]))
);
}

function canPostBulletin(projectIds) {
return projectIds.size() > 0 && projectIds.size() <= 5 &&
  canPostToProject(projectIds[0]) &&
  (projectIds.size() < 2 || canPostToProject(projectIds[1])) &&
  (projectIds.size() < 3 || canPostToProject(projectIds[2])) &&
  (projectIds.size() < 4 || canPostToProject(projectIds[3])) &&
  (projectIds.size() < 5 || canPostToProject(projectIds[4]));
}

match /users/{uid} {
allow read, write: if signedIn() && uid == request.auth.uid;
}

match /bulletinPosts/{postId} {
allow read: if signedIn() && canViewBulletin(resource.data.projectIds);
allow create: if signedIn() && canPostBulletin(request.resource.data.projectIds);
allow update, delete: if signedIn() &&
  request.auth.uid == resource.data.authorId &&
  canPostBulletin(resource.data.projectIds) &&
  canPostBulletin(request.resource.data.projectIds);
}

match /projects/{projectId} {
allow create: if signedIn();
allow read: if isMember(projectId);
allow update, delete: if isMember(projectId) && role(projectId) == 'admin';


match /issues/{issueId} {
allow read: if isMember(projectId);
allow create, update: if isMember(projectId);
allow delete: if isMember(projectId) && role(projectId) == 'admin';


match /tasks/{taskId} {
allow read: if isMember(projectId);
allow create, update: if isMember(projectId);
allow delete: if isMember(projectId) && role(projectId) == 'admin';


match /comments/{commentId} {
allow read: if isMember(projectId);
allow create: if isMember(projectId);
allow delete: if isMember(projectId) && (resource.data.authorId == request.auth.uid || role(projectId) == 'admin');
}
}
}


match /invites/{inviteId} {
allow read: if isMember(projectId); // 受け取り側で照合する想定
allow create, update, delete: if isMember(projectId) && role(projectId) == 'admin';
}
}


// フラットなコレクションを使う MVP 用（後で削除可）
match /tasks/{taskId} {
allow read, write: if signedIn();
}
}
}
